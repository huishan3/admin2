<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Bean | å¾Œç«¯ç®¡ç†ä»‹é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #b58863;
        }
        input[type="text"], input[type="number"], input[type=\"date\"], textarea, select {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box; /* Ensures padding doesn't increase total width */
        }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-blue { background-color: #4299e1; }
        .btn-blue:hover { background-color: #3182ce; }
        .btn-green { background-color: #48bb78; }
        .btn-green:hover { background-color: #38a169; }
        .btn-purple { background-color: #805ad5; }
        .btn-purple:hover { background-color: #6b46c1; }
        .btn-yellow { background-color: #ecc94b; }
        .btn-yellow:hover { background-color: #d69e2e; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .card {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background-color: #fdfdfd;
        }
        .item-list li {
            background-color: #fdfaf5;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f0f0f0;
        }
        /* Custom styles for admin message modal */
        .admin-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .admin-modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        .admin-modal-close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .admin-modal-close-button:hover,
        .admin-modal-close-button:focus {
            color: black;
        }
        .admin-modal-success { color: #48bb78; } /* Green */
        .admin-modal-error { color: #ef4444; } /* Red */
    </style>
</head>
<body>
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold mb-8">Melody Bean å¾Œç«¯ç®¡ç†ä»‹é¢</h1>

        <section class="mb-12">
            <h2 class="text-3xl font-semibold mb-6">å’–å•¡è±†ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-4">ç¾æœ‰å’–å•¡è±†åˆ—è¡¨</h3>
                <ul id="admin-coffee-list" class="item-list list-none pl-0 space-y-2 mb-4">
                    <!-- Coffee beans will be listed here -->
                </ul>
                <div class="flex gap-2">
                    <button id="load-coffee-data" class="btn-blue">è¼‰å…¥å’–å•¡è±†æ•¸æ“š</button>
                    <button id="save-coffee-data" class="btn-green">å„²å­˜å’–å•¡è±†æ•¸æ“š</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">æ–°å¢ / ç·¨è¼¯å’–å•¡è±†</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="hidden" id="edit-coffee-id">
                    <input type="text" id="coffee-name" placeholder="åç¨± (å¿…å¡«)" class="p-2 border rounded-md" required>
                    <input type="text" id="coffee-country" placeholder="åœ‹å®¶" class="p-2 border rounded-md">
                    <input type="text" id="coffee-variety" placeholder="å“ç¨®" class="p-2 border rounded-md">
                    <input type="text" id="coffee-flavor" placeholder="é¢¨å‘³æè¿°" class="p-2 border rounded-md">
                    <select id="coffee-roast" class="p-2 border rounded-md">
                        <option value="" disabled selected>çƒ˜ç„™åº¦</option>
                        <option value="æ·ºç„™">æ·ºç„™</option>
                        <option value="ä¸­æ·ºç„™">ä¸­æ·ºç„™</option>
                        <option value="ä¸­ç„™">ä¸­ç„™</option>
                        <option value="ä¸­æ·±ç„™">ä¸­æ·±ç„™</option>
                        <option value="æ·±ç„™">æ·±ç„™</option>
                    </select>
                    <input type="text" id="coffee-weight" placeholder="é‡é‡ (ä¾‹å¦‚: 114g, 227g)" class="p-2 border rounded-md">
                    <input type="number" id="coffee-price" placeholder="å”®åƒ¹ (å¿…å¡«)" class="p-2 border rounded-md" required>
                    <input type="date" id="coffee-expiry" placeholder="æœŸé™ (YYYY-MM-DD)" class="p-2 border rounded-md">
                    <input type="number" id="coffee-stock" placeholder="åº«å­˜ (æ•¸é‡) (å¿…å¡«)" min="0" class="p-2 border rounded-md" required> <!-- NEW STOCK FIELD -->
                    <select id="coffee-category" class="p-2 border rounded-md">
                        <option value="" disabled selected>åˆ†é¡</option>
                        <option value="light">æ·ºç„™é¡</option>
                        <option value="medium">ä¸­ç„™é¡</option>
                        <option value="dark">æ·±ç„™é¡</option>
                    </select>
                    <input type="text" id="coffee-image" placeholder="åœ–ç‰‡URL (ä¾‹å¦‚: ./image/image_1.png æˆ– placehold.co)" class="p-2 border rounded-md col-span-2">
                    <textarea id="coffee-lifestyle" placeholder="ç”Ÿæ´»ææ¡ˆ (ä¾‹å¦‚: é©åˆåœ¨éœè¬çš„åˆå¾Œç´°ç´°å“å‘³)" class="p-2 border rounded-md col-span-2"></textarea>
                    
                    <!-- Flavor Profile Inputs (optional, could be more complex UI) -->
                    <h4 class="col-span-2 text-md font-semibold mt-2">é¢¨å‘³åœ–è­œè©•åˆ† (1-5)</h4>
                    <input type="number" id="fp-acidity" placeholder="é…¸åº¦" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-body" placeholder="é†‡åšåº¦" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-sweetness" placeholder="ç”œåº¦" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-aroma" placeholder="é¦™æ°£" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-finish" placeholder="é¤˜éŸ»" min="0" max="5" class="p-2 border rounded-md">
                </div>
                <div class="flex gap-2">
                    <button id="add-coffee" class="btn-purple">æ–°å¢å’–å•¡è±†</button>
                    <button id="update-coffee" class="btn-yellow">æ›´æ–°é¸å®šå’–å•¡è±†</button>
                    <button id="clear-coffee-form" class="btn-blue">æ¸…é™¤è¡¨å–®</button>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-3xl font-semibold mb-6">å„ªæƒ æ´»å‹•ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-4">ç¾æœ‰å„ªæƒ æ´»å‹•åˆ—è¡¨</h3>
                <ul id="admin-offer-list" class="item-list list-none pl-0 space-y-2 mb-4">
                    <!-- Offers will be listed here -->
                </ul>
                <div class="flex gap-2">
                    <button id="load-offer-data" class="btn-blue">è¼‰å…¥å„ªæƒ æ•¸æ“š</button>
                    <button id="save-offer-data" class="btn-green">å„²å­˜å„ªæƒ æ•¸æ“š</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">æ–°å¢ / ç·¨è¼¯å„ªæƒ </h3>
                <input type="hidden" id="edit-offer-id">
                <input type="text" id="offer-name" placeholder="åç¨± (å¿…å¡«)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="text" id="offer-description" placeholder="æè¿° (å¿…å¡«)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="number" id="offer-original-price" placeholder="åŸåƒ¹ (å¿…å¡«)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="number" id="offer-special-price" placeholder="ç‰¹åƒ¹ (å¿…å¡«)" class="p-2 border rounded-md w-full mb-4" required>
                <input type="text" id="offer-image" placeholder="åœ–ç‰‡URL (ä¾‹å¦‚: placehold.co)" class="p-2 border rounded-md w-full mb-4">
                <div class="flex gap-2">
                    <button id="add-offer" class="btn-purple">æ–°å¢å„ªæƒ </button>
                    <button id="update-offer" class="btn-yellow">æ›´æ–°é¸å®šå„ªæƒ </button>
                    <button id="clear-offer-form" class="btn-blue">æ¸…é™¤è¡¨å–®</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Admin Message Modal -->
    <div id="adminMessageModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-modal-close-button" onclick="closeAdminMessageModal()">&times;</span>
            <h3 id="adminModalTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="adminModalMessage" class="text-gray-700 mb-6"></p>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="closeAdminMessageModal()">äº†è§£</button>
        </div>
    </div>

    <script>
        'use strict';
        (function() { // Start IIFE

        // ğŸ“¦ dataManager.js - çµ±ä¸€å„ªæƒ è³‡æ–™ç®¡ç†æ¨¡çµ„
        // é€™éƒ¨åˆ†æ˜¯æ‚¨æä¾›çš„ dataManager.js å…§å®¹ï¼Œç›´æ¥åµŒå…¥åˆ° HTML ä¸­ä»¥ç¢ºä¿å¯ç”¨æ€§
        const defaultOfferTemplate = {
            id: 0,
            name: '',
            description: '',
            originalPrice: 0,
            specialPrice: 0,
            image: ''
        };

        const SPECIAL_OFFERS_KEY = 'melodySpecialOffers';

        // æ–°å¢é è¨­å„ªæƒ æ´»å‹•è³‡æ–™ï¼Œç¢ºä¿å‰å¾Œå°é è¨­å€¼ä¸€è‡´
        const DEFAULT_SPECIAL_OFFERS = [
            { id: 101, name: 'é è¨­å„ªæƒ ï¼šç³»çµ±åˆå§‹é«”é©—åŒ…', description: 'é€™æ˜¯ç³»çµ±é è¨­çš„å„ªæƒ ï¼Œå¦‚æœlocalStorageä¸­æ²’æœ‰æ•¸æ“šï¼Œå°‡æœƒé¡¯ç¤ºæ­¤å„ªæƒ ã€‚', originalPrice: 500, specialPrice: 400, image: 'https://placehold.co/400x200/b58863/FFFFFF?text=Default+Offer' }
        ];

        /**
         * ğŸ§  mergeWithDefaultSchema
         * å°‡è¼¸å…¥çš„æ¯ç­†è³‡æ–™è£œé½Šç‚ºèˆ‡é è¨­æ¬„ä½ä¸€è‡´çš„æ ¼å¼
         * @param {Array<Object>} dataArray - åŸå§‹å„ªæƒ è³‡æ–™
         * @param {Object} defaultTemplate - æ¬„ä½æ¨¡æ¿
         * @returns {Array<Object>}
         */
        function mergeWithDefaultSchema(dataArray, defaultTemplate) {
            if (!Array.isArray(dataArray)) return [];
            return dataArray.map(item => ({
                ...defaultTemplate,
                ...item
            }));
        }

        /**
         * ğŸ“¥ loadOffersFromLocalStorage
         * å¾ localStorage è®€å–å„ªæƒ è³‡æ–™ï¼Œä¸¦è£œé½Šæ¬„ä½æ ¼å¼
         * @returns {Array<Object>}
         */
        function loadOffersFromLocalStorage() {
            try {
                const rawData = JSON.parse(localStorage.getItem(SPECIAL_OFFERS_KEY));
                return mergeWithDefaultSchema(rawData || [], defaultOfferTemplate);
            } catch (e) {
                console.error('[å„ªæƒ è³‡æ–™è¼‰å…¥å¤±æ•—]', e);
                return [];
            }
        }

        /**
         * ğŸ“¤ saveOffersToLocalStorage
         * å°‡å„ªæƒ è³‡æ–™å„²å­˜è‡³ localStorage
         * @param {Array<Object>} offers
         */
        function saveOffersToLocalStorage(offers) {
            try {
                localStorage.setItem(SPECIAL_OFFERS_KEY, JSON.stringify(offers));
            } catch (e) {
                console.error('[å„ªæƒ è³‡æ–™å„²å­˜å¤±æ•—]', e);
            }
        }

        /**
         * ğŸ—‘ clearOffers
         * æ¸…é™¤ localStorage ä¸­çš„å„ªæƒ è³‡æ–™
         */
        function clearOffers() {
            localStorage.removeItem(SPECIAL_OFFERS_KEY);
        }

        // âœ… å…¨åŸŸæ›è¼‰æ¨¡çµ„ï¼Œä¾›å‰å¾Œå°å‘¼å«
        window.OfferDataManager = {
            loadOffersFromLocalStorage,
            saveOffersToLocalStorage,
            clearOffers,
            mergeWithDefaultSchema,
            defaultOfferTemplate,
            DEFAULT_SPECIAL_OFFERS // å°‡çµ±ä¸€çš„é è¨­å„ªæƒ è³‡æ–™åŒ¯å‡º
        };
        // ğŸ“¦ dataManager.js END

        // --- Local Storage Keys ---
        const COFFEE_BEANS_KEY = 'melodyCoffeeBeans';

        // --- Default Data (Hardcoded for initial setup if localStorage is empty) ---
        const defaultCoffeeBeans = [
            { id: 1, name: 'GEISHA æ°´æ´—ï¼ˆ114gï¼‰', country: 'è¡£ç´¢æ¯”äº', variety: 'GEISHA æ°´æ´—', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬ã€ç™¾é¦™æœ', roast: 'æ·ºç„™', weight: '114g', expiryDate: '2025-10-12', price: 280, stock: 10, category: 'light', image: './image/image_1.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'é€™æ¬¾å’–å•¡å……æ»¿è¤‡é›œçš„é¦™æ°£èˆ‡æ˜äº®çš„é¢¨å‘³ï¼Œé©åˆåœ¨éœè¬çš„åˆå¾Œç´°ç´°å“å‘³ï¼Œæˆ–æ­é…è¼•ç›ˆçš„ç”œé»ã€‚' },
            { id: 2, name: 'Heirloom é›™é‡å­æ°§ï¼ˆ227gï¼‰- æ‰¹æ¬¡A', country: 'è¡£ç´¢æ¯”äº', variety: 'Heirloom', flavor: 'èŒ‰è‰ã€æ©™èŠ±ã€èœ‚èœœã€æ°´èœœæ¡ƒ', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-10-28', price: 600, stock: 5, category: 'light', image: './image/image_2.png', flavorProfile: { acidity: 4, body: 3, sweetness: 5, aroma: 5, finish: 4 }, lifestyle: 'ç”œç¾è€Œè±å¯Œçš„å£æ„Ÿï¼Œæ˜¯é–‹å•Ÿç¾å¥½ä¸€å¤©çš„ç†æƒ³é¸æ“‡ï¼Œèˆ‡æ—©é¤ç³•é»æ­é…å°¤ä½³ã€‚' },
            { id: 3, name: 'Heirloom é›™é‡å­æ°§ï¼ˆ227gï¼‰- æ‰¹æ¬¡B', country: 'è¡£ç´¢æ¯”äº', variety: 'Heirloom', flavor: 'èŒ‰è‰ã€æ©™èŠ±ã€èœ‚èœœã€æ°´èœœæ¡ƒ', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-10-31', price: 600, stock: 8, category: 'light', image: './image/image_3.png', flavorProfile: { acidity: 4, body: 3, sweetness: 5, aroma: 5, finish: 4 }, lifestyle: 'ç›¸åŒçš„é¢¨å‘³ï¼Œä¸åŒçš„æ¡æ”¶æ‰¹æ¬¡ï¼Œç¢ºä¿æ¯ä¸€æ¯éƒ½æœ‰å§‹çµ‚å¦‚ä¸€çš„ç”œèœœèˆ‡èŠ¬èŠ³ã€‚' },
            { id: 4, name: 'GEISHAï¼ˆ227gï¼‰ä¸­æ·ºç„™', country: 'è¡£ç´¢æ¯”äº', variety: 'GEISHA', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬', roast: 'ä¸­æ·ºç„™', weight: '227g', expiryDate: '2025-11-01', price: 540, stock: 12, category: 'medium', image: './image/image_4.png', flavorProfile: { acidity: 3, body: 3, sweetness: 3, aroma: 4, finish: 3 }, lifestyle: 'å¹³è¡¡çš„é¢¨å‘³èˆ‡è¼ƒä½çš„é…¸åº¦ï¼Œé©åˆæ—¥å¸¸é£²ç”¨ï¼Œç„¡è«–æ˜¯æ­é…é–±è®€æˆ–å·¥ä½œï¼Œéƒ½èƒ½å¸¶ä¾†æ„‰æ‚…æ„Ÿå—ã€‚' },
            { id: 5, name: 'GEISHA æ°´æ´—ï¼ˆ227gï¼‰2280m', country: 'è¡£ç´¢æ¯”äº', variety: 'GEISHA æ°´æ´—', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬', roast: 'ä¸­æ·ºç„™', weight: '227g', expiryDate: '2025-11-05', price: 580, stock: 0, category: 'light', image: './image/image_5.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'ä¾†è‡ªé«˜æµ·æ‹”çš„ç¨ç‰¹é¢¨å‘³ï¼Œå»ºè­°åœ¨éœ€è¦ææŒ¯ç²¾ç¥çš„æ—©æ™¨å“åšï¼Œæ„Ÿå—å…¶æ¸…æ™°æ˜äº®çš„å±¤æ¬¡ã€‚' },
            { id: 6, name: 'è¡£ç´¢æ¯”äº æ·ºç„™ï¼ˆ227gï¼‰', country: 'è¡£ç´¢æ¯”äº', variety: '', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-11-01', price: 540, stock: 7, category: 'light', image: './image/image_6.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'è¼•ç›ˆçš„èŠ±æœèª¿æ€§ï¼Œæ˜¯ä¸‹åˆèŒ¶æ™‚å…‰çš„å®Œç¾ä¼´ä¾¶ï¼Œèƒ½ç‚ºæ‚¨çš„ä¼‘æ†©æ™‚åˆ»å¢æ·»ä¸€æŠ¹äº®è‰²ã€‚' },
            { id: 7, name: 'å“¥æ–¯å¤§é»åŠ  Geisha ç™½èœœï¼ˆ114gï¼‰', country: 'å“¥æ–¯å¤§é»åŠ ', variety: 'Geishaï¼ˆè—å¦“ï¼‰', flavor: 'ç™¾åˆèŠ±ã€é‡è–‘èŠ±ã€æª¸æª¬è‰ã€æŸ‘æ©˜ã€ç´…è‰²è“æœã€èœ‚èœœ', roast: 'æ·ºç„™', weight: '114g', expiryDate: '2025-08-15', price: 800, stock: 3, category: 'light', image: './image/image_7.png', flavorProfile: { acidity: 5, body: 3, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'æ­¤æ¬¾è—å¦“å’–å•¡é¢¨å‘³ç²¾ç·»å„ªé›…ï¼Œé©åˆåœ¨é‡è¦æ™‚åˆ»æˆ–èˆ‡å¥½å‹åˆ†äº«ï¼Œæ­é…ç°¡ç´„çš„ç”œé»ä»¥çªé¡¯å…¶è±å¯Œå±¤æ¬¡ã€‚' },
            { id: 8, name: 'å“¥æ–¯å¤§é»åŠ  æ·ºç„™ï¼ˆ227gï¼‰', country: 'å“¥æ–¯å¤§é»åŠ ', variety: '', flavor: 'ç™¾åˆèŠ±ã€é‡è–‘èŠ±ã€æª¸æª¬è‰ã€æŸ‘æ©˜ã€ç´…è‰²è“æœã€èœ‚èœœ', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-08-15', price: 1800, stock: 1, category: 'light', image: './image/image_8.png', flavorProfile: { acidity: 5, body: 3, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'å¤§å®¹é‡åŒ…è£è®“æ‚¨èƒ½æ›´é•·æ™‚é–“åœ°äº«å—è—å¦“å’–å•¡çš„è¿·äººé­…åŠ›ï¼Œæ¯æ—¥å“é£²æˆ–ä½œç‚ºçè²´è´ˆç¦®çš†å®œã€‚' }
        ];

        // --- Data Variables (will be loaded from/saved to localStorage) ---
        let coffeeBeans = [];
        let specialOffers = []; // This will now be populated by OfferDataManager
        let reviews = []; 

        let radarChart; // Chart.js instance


        // --- DOM Elements ---
        const adminCoffeeList = document.getElementById('admin-coffee-list');
        const loadCoffeeBtn = document.getElementById('load-coffee-data');
        const saveCoffeeBtn = document.getElementById('save-coffee-data');
        const addCoffeeBtn = document.getElementById('add-coffee');
        const updateCoffeeBtn = document.getElementById('update-coffee');
        const clearCoffeeFormBtn = document.getElementById('clear-coffee-form');

        const editCoffeeIdInput = document.getElementById('edit-coffee-id');
        const coffeeNameInput = document.getElementById('coffee-name');
        const coffeeCountryInput = document.getElementById('coffee-country');
        const coffeeVarietyInput = document.getElementById('coffee-variety');
        const coffeeFlavorInput = document.getElementById('coffee-flavor');
        const coffeeRoastInput = document.getElementById('coffee-roast');
        const coffeeWeightInput = document.getElementById('coffee-weight');
        const coffeePriceInput = document.getElementById('coffee-price');
        const coffeeExpiryInput = document.getElementById('coffee-expiry');
        const coffeeStockInput = document.getElementById('coffee-stock'); // NEW
        const coffeeCategoryInput = document.getElementById('coffee-category');
        const coffeeImageInput = document.getElementById('coffee-image');
        const coffeeLifestyleInput = document.getElementById('coffee-lifestyle');

        const fpAcidityInput = document.getElementById('fp-acidity');
        const fpBodyInput = document.getElementById('fp-body');
        const fpSweetnessInput = document.getElementById('fp-sweetness');
        const fpAromaInput = document.getElementById('fp-aroma');
        const fpFinishInput = document.getElementById('fp-finish');


        const adminOfferList = document.getElementById('admin-offer-list');
        const loadOfferBtn = document.getElementById('load-offer-data');
        const saveOfferBtn = document.getElementById('save-offer-data');
        const addOfferBtn = document.getElementById('add-offer');
        const updateOfferBtn = document.getElementById('update-offer');
        const clearOfferFormBtn = document.getElementById('clear-offer-form');

        const editOfferIdInput = document.getElementById('edit-offer-id');
        const offerNameInput = document.getElementById('offer-name');
        const offerDescriptionInput = document.getElementById('offer-description');
        const offerOriginalPriceInput = document.getElementById('offer-original-price');
        const offerSpecialPriceInput = document.getElementById('offer-special-price');
        const offerImageInput = document.getElementById('offer-image');

        // --- Admin Message Modal Elements ---
        const adminMessageModal = document.getElementById('adminMessageModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminModalMessage = document.getElementById('adminModalMessage');

        /**
         * Shows the custom admin message modal.
         * @param {string} title - The title of the message.
         * @param {string} message - The message content.
         * @param {string} type - 'success' or 'error' to change title color.
         * @param {function} [onConfirm] - Optional callback function for confirm type modals.
         * @param {boolean} [isConfirm=false] - Whether this modal is a confirmation dialog.
         */
        function showAdminMessageModal(title, message, type = 'info', onConfirm = null, isConfirm = false) {
            adminModalTitle.textContent = title;
            adminModalMessage.textContent = message;
            adminModalTitle.classList.remove('admin-modal-success', 'admin-modal-error');
            
            const confirmButton = adminMessageModal.querySelector('button');
            const originalButtonText = "äº†è§£"; // Default button text
            confirmButton.onclick = closeAdminMessageModal; // Default close action

            if (type === 'success') {
                adminModalTitle.classList.add('admin-modal-success');
            } else if (type === 'error') {
                adminModalTitle.classList.add('admin-modal-error');
            }

            if (isConfirm && onConfirm) {
                confirmButton.textContent = "ç¢ºèª";
                confirmButton.onclick = () => {
                    onConfirm();
                    closeAdminMessageModal();
                };
                // You might add a "Cancel" button here for true confirmations if needed.
                // For simplicity, keeping it as one button that triggers action then closes.
            } else {
                confirmButton.textContent = originalButtonText;
            }
            adminMessageModal.style.display = 'flex';
        }

        /**
         * Closes the custom admin message modal.
         */
        function closeAdminMessageModal() {
            adminMessageModal.style.display = 'none';
        }


        // --- Helper Functions ---
        /**
         * Generates a simple pseudo-unique ID.
         * In a real app, use UUIDs or backend-generated IDs.
         */
        function generateId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        // --- Coffee Bean Functions ---
        function renderCoffeeBeansAdmin() {
            adminCoffeeList.innerHTML = '';
            if (coffeeBeans.length === 0) {
                adminCoffeeList.innerHTML = '<li>ç›®å‰æ²’æœ‰å’–å•¡è±†æ•¸æ“šã€‚</li>';
                return;
            }
            coffeeBeans.forEach(bean => {
                const listItem = document.createElement('li');
                listItem.dataset.id = bean.id;
                // Display updated fields including stock
                listItem.innerHTML = `
                    <span>${bean.name} (NT$${bean.price}) - åº«å­˜: ${bean.stock}</span>
                    <div>
                        <button class="btn-yellow text-sm py-1 px-2 mr-1 edit-coffee-btn">ç·¨è¼¯</button>
                        <button class="btn-red text-sm py-1 px-2 delete-coffee-btn">åˆªé™¤</button>
                    </div>
                `;
                adminCoffeeList.appendChild(listItem);
            });

            // Attach event listeners for edit and delete
            document.querySelectorAll('.edit-coffee-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('li').dataset.id;
                    const beanToEdit = coffeeBeans.find(b => b.id == id);
                    if (beanToEdit) {
                        editCoffeeIdInput.value = beanToEdit.id;
                        coffeeNameInput.value = beanToEdit.name;
                        coffeeCountryInput.value = beanToEdit.country || '';
                        coffeeVarietyInput.value = beanToEdit.variety || '';
                        coffeeFlavorInput.value = beanToEdit.flavor;
                        coffeeRoastInput.value = beanToEdit.roast || '';
                        coffeeWeightInput.value = beanToEdit.weight || '';
                        coffeePriceInput.value = beanToEdit.price;
                        coffeeExpiryInput.value = beanToEdit.expiryDate;
                        coffeeStockInput.value = beanToEdit.stock; // Populate stock field
                        coffeeCategoryInput.value = beanToEdit.category || '';
                        coffeeImageInput.value = beanToEdit.image;
                        coffeeLifestyleInput.value = beanToEdit.lifestyle;

                        // Populate flavor profile inputs
                        if (beanToEdit.flavorProfile) {
                            fpAcidityInput.value = beanToEdit.flavorProfile.acidity || 0;
                            fpBodyInput.value = beanToEdit.flavorProfile.body || 0;
                            fpSweetnessInput.value = beanToEdit.flavorProfile.sweetness || 0;
                            fpAromaInput.value = beanToEdit.flavorProfile.aroma || 0;
                            fpFinishInput.value = beanToEdit.flavorProfile.finish || 0;
                        } else {
                            // Clear if no flavor profile exists
                            fpAcidityInput.value = '';
                            fpBodyInput.value = '';
                            fpSweetnessInput.value = '';
                            fpAromaInput.value = '';
                            fpFinishInput.value = '';
                        }
                    }
                });
            });

            document.querySelectorAll('.delete-coffee-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.closest('li').dataset.id);
                    showAdminMessageModal('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤æ­¤å’–å•¡è±†å—ï¼Ÿ', 'info', () => {
                        coffeeBeans = coffeeBeans.filter(bean => bean.id !== id);
                        saveCoffeeBeans(); // Save immediately after delete
                        renderCoffeeBeansAdmin();
                        clearCoffeeForm();
                        showAdminMessageModal('æˆåŠŸ', 'å’–å•¡è±†å·²åˆªé™¤ï¼', 'success');
                    }, true); // Pass true for confirmation
                });
            });
        }

        function loadCoffeeBeans() {
            let storedBeans = JSON.parse(localStorage.getItem(COFFEE_BEANS_KEY));
            if (Array.isArray(storedBeans) && storedBeans.length > 0) {
                // Merge existing data with default structure to ensure new fields are present
                // This handles cases where localStorage might have old schema
                coffeeBeans = storedBeans.map(bean => ({
                    // Ensure 'stock' is included even if not in old stored data
                    stock: 0, // Default for new 'stock' field if missing
                    ...defaultCoffeeBeans[0], // Use a template from default to ensure all keys exist
                    ...bean // Overlay existing values
                }));
            } else {
                coffeeBeans = [...defaultCoffeeBeans]; // Use spread to avoid modifying default array directly
                // If localStorage is empty, save the default beans to it
                localStorage.setItem(COFFEE_BEANS_KEY, JSON.stringify(defaultCoffeeBeans));
            }
            renderCoffeeBeansAdmin();
            clearCoffeeForm();
            showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'å’–å•¡è±†æ•¸æ“šå·²è¼‰å…¥ã€‚', 'success');
            console.log('Coffee beans loaded (Admin).');
        }

        function saveCoffeeBeans() {
            localStorage.setItem(COFFEE_BEANS_KEY, JSON.stringify(coffeeBeans));
            showAdminMessageModal('å„²å­˜æˆåŠŸ', 'å’–å•¡è±†æ•¸æ“šå·²å„²å­˜ï¼', 'success');
            console.log('Coffee beans saved (Admin).');
        }

        function clearCoffeeForm() {
            editCoffeeIdInput.value = '';
            coffeeNameInput.value = '';
            coffeeCountryInput.value = '';
            coffeeVarietyInput.value = '';
            coffeeFlavorInput.value = '';
            coffeeRoastInput.value = '';
            coffeeWeightInput.value = '';
            coffeePriceInput.value = '';
            coffeeExpiryInput.value = '';
            coffeeStockInput.value = ''; // Clear stock field
            coffeeCategoryInput.value = '';
            coffeeImageInput.value = '';
            coffeeLifestyleInput.value = '';
            fpAcidityInput.value = '';
            fpBodyInput.value = '';
            fpSweetnessInput.value = '';
            fpAromaInput.value = '';
            fpFinishInput.value = '';
        }

        // --- Special Offer Functions ---
        function renderSpecialOffersAdmin() {
            adminOfferList.innerHTML = '';
            if (specialOffers.length === 0) {
                adminOfferList.innerHTML = '<li>ç›®å‰æ²’æœ‰å„ªæƒ æ´»å‹•æ•¸æ“šã€‚</li>';
                return;
            }
            specialOffers.forEach(offer => {
                const listItem = document.createElement('li');
                listItem.dataset.id = offer.id;
                listItem.innerHTML = `
                    <span>${offer.name} (NT$${offer.specialPrice})</span>
                    <div>
                        <button class="btn-yellow text-sm py-1 px-2 mr-1 edit-offer-btn">ç·¨è¼¯</button>
                        <button class="btn-red text-sm py-1 px-2 delete-offer-btn">åˆªé™¤</button>
                    </div>
                `;
                adminOfferList.appendChild(listItem);
            });

            // Attach event listeners for edit and delete
            document.querySelectorAll('.edit-offer-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.closest('li').dataset.id;
                    const offerToEdit = specialOffers.find(o => o.id == id);
                    if (offerToEdit) {
                        editOfferIdInput.value = offerToEdit.id;
                        offerNameInput.value = offerToEdit.name;
                        offerDescriptionInput.value = offerToEdit.description;
                        offerOriginalPriceInput.value = offerToEdit.originalPrice;
                        offerSpecialPriceInput.value = offerToEdit.specialPrice;
                        offerImageInput.value = offerToEdit.image;
                    }
                });
            });

            document.querySelectorAll('.delete-offer-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.closest('li').dataset.id);
                    showAdminMessageModal('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤æ­¤å„ªæƒ å—ï¼Ÿ', 'info', () => {
                        specialOffers = specialOffers.filter(offer => offer.id !== id);
                        saveSpecialOffers(); // Save immediately after delete
                        renderSpecialOffersAdmin();
                        clearOfferForm();
                        showAdminMessageModal('æˆåŠŸ', 'å„ªæƒ æ´»å‹•å·²åˆªé™¤ï¼', 'success');
                    }, true); // Pass true for confirmation
                });
            });
        }

        function loadSpecialOffers() {
            // Use the new OfferDataManager to load data
            specialOffers = window.OfferDataManager.loadOffersFromLocalStorage();
            // If localStorage is empty and OfferDataManager returns empty, seed with the centralized default offers
            if (specialOffers.length === 0) {
                specialOffers = window.OfferDataManager.mergeWithDefaultSchema(window.OfferDataManager.DEFAULT_SPECIAL_OFFERS, window.OfferDataManager.defaultOfferTemplate);
                window.OfferDataManager.saveOffersToLocalStorage(specialOffers); // Save to populate localStorage
            }
            renderSpecialOffersAdmin();
            clearOfferForm();
            showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'å„ªæƒ æ•¸æ“šå·²è¼‰å…¥ã€‚', 'success');
            console.log('Special offers loaded (Admin).');
        }

        function saveSpecialOffers() {
            // Use the new OfferDataManager to save data
            window.OfferDataManager.saveOffersToLocalStorage(specialOffers);
            showAdminMessageModal('å„²å­˜æˆåŠŸ', 'å„ªæƒ æ•¸æ“šå·²å„²å­˜ï¼', 'success');
            console.log('Special offers saved (Admin).');
        }

        function clearOfferForm() {
            editOfferIdInput.value = '';
            offerNameInput.value = '';
            offerDescriptionInput.value = '';
            offerOriginalPriceInput.value = '';
            offerSpecialPriceInput.value = '';
            offerImageInput.value = '';
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Coffee Bean Event Listeners
            loadCoffeeBtn.addEventListener('click', loadCoffeeBeans);
            saveCoffeeBtn.addEventListener('click', saveCoffeeBeans);

            addCoffeeBtn.addEventListener('click', () => {
                // Basic validation for required fields
                if (!coffeeNameInput.value || !coffeePriceInput.value || coffeeStockInput.value === '') {
                    showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å’–å•¡è±†æ¬„ä½ã€‚', 'error');
                    return;
                }

                const newBean = {
                    id: generateId(), // Simple ID generation
                    name: coffeeNameInput.value,
                    country: coffeeCountryInput.value,
                    variety: coffeeVarietyInput.value,
                    flavor: coffeeFlavorInput.value,
                    roast: coffeeRoastInput.value,
                    weight: coffeeWeightInput.value,
                    price: parseFloat(coffeePriceInput.value) || 0,
                    expiryDate: coffeeExpiryInput.value,
                    stock: parseInt(coffeeStockInput.value) || 0, // NEW: Add stock
                    category: coffeeCategoryInput.value,
                    image: coffeeImageInput.value || './image/placeholder-coffee.png', // Fallback local placeholder
                    flavorProfile: { 
                        acidity: parseFloat(fpAcidityInput.value) || 0, 
                        body: parseFloat(fpBodyInput.value) || 0, 
                        sweetness: parseFloat(fpSweetnessInput.value) || 0, 
                        aroma: parseFloat(fpAromaInput.value) || 0, 
                        finish: parseFloat(fpFinishInput.value) || 0 
                    }, 
                    lifestyle: coffeeLifestyleInput.value || 'äº«å—ä¸€æ¯ç¾å¥½çš„å’–å•¡ã€‚'
                };
                coffeeBeans.push(newBean);
                saveCoffeeBeans();
                renderCoffeeBeansAdmin();
                clearCoffeeForm();
                showAdminMessageModal('æˆåŠŸ', 'å’–å•¡è±†å·²æ–°å¢ï¼', 'success');
            });

            updateCoffeeBtn.addEventListener('click', () => {
                const idToUpdate = parseInt(editCoffeeIdInput.value);
                const beanIndex = coffeeBeans.findIndex(bean => bean.id === idToUpdate);

                if (beanIndex === -1) {
                    showAdminMessageModal('æ›´æ–°éŒ¯èª¤', 'è«‹é¸æ“‡è¦æ›´æ–°çš„å’–å•¡è±†ã€‚', 'error');
                    return;
                }

                // Basic validation for required fields
                if (!coffeeNameInput.value || !coffeePriceInput.value || coffeeStockInput.value === '') {
                    showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å’–å•¡è±†æ¬„ä½ã€‚', 'error');
                    return;
                }

                coffeeBeans[beanIndex] = {
                    ...coffeeBeans[beanIndex], // Keep existing properties
                    name: coffeeNameInput.value,
                    country: coffeeCountryInput.value,
                    variety: coffeeVarietyInput.value,
                    flavor: coffeeFlavorInput.value,
                    roast: coffeeRoastInput.value,
                    weight: coffeeWeightInput.value,
                    price: parseFloat(coffeePriceInput.value) || 0,
                    expiryDate: coffeeExpiryInput.value,
                    stock: parseInt(coffeeStockInput.value) || 0, // NEW: Update stock
                    category: coffeeCategoryInput.value,
                    image: coffeeImageInput.value || coffeeBeans[beanIndex].image,
                    lifestyle: coffeeLifestyleInput.value,
                    flavorProfile: { // Update flavor profile
                        acidity: parseFloat(fpAcidityInput.value) || 0,
                        body: parseFloat(fpBodyInput.value) || 0,
                        sweetness: parseFloat(fpSweetnessInput.value) || 0,
                        aroma: parseFloat(fpAromaInput.value) || 0,
                        finish: parseFloat(fpFinishInput.value) || 0
                    }
                };
                saveCoffeeBeans();
                renderCoffeeBeansAdmin();
                clearCoffeeForm();
                showAdminMessageModal('æˆåŠŸ', 'å’–å•¡è±†å·²æ›´æ–°ï¼', 'success');
            });

            clearCoffeeFormBtn.addEventListener('click', clearCoffeeForm);

            // Special Offer Event Listeners
            loadOfferBtn.addEventListener('click', loadSpecialOffers);
            saveOfferBtn.addEventListener('click', saveSpecialOffers);

            addOfferBtn.addEventListener('click', () => {
                // Basic validation for required fields
                if (!offerNameInput.value || !offerDescriptionInput.value || !offerOriginalPriceInput.value || !offerSpecialPriceInput.value) {
                    showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å„ªæƒ æ´»å‹•æ¬„ä½ã€‚', 'error');
                    return;
                }

                // Use the manager's merge function for consistency, even for new offers
                const newOffer = window.OfferDataManager.mergeWithDefaultSchema([{ 
                    id: generateId(), 
                    name: offerNameInput.value,
                    description: offerDescriptionInput.value,
                    originalPrice: parseFloat(offerOriginalPriceInput.value) || 0,
                    specialPrice: parseFloat(offerSpecialPriceInput.value) || 0,
                    image: offerImageInput.value || 'https://placehold.co/400x250/cccccc/333333?text=æ–°å„ªæƒ '
                }], window.OfferDataManager.defaultOfferTemplate)[0]; // Ensure it merges with the template

                specialOffers.push(newOffer);
                saveSpecialOffers();
                renderSpecialOffersAdmin();
                clearOfferForm();
                showAdminMessageModal('æˆåŠŸ', 'å„ªæƒ æ´»å‹•å·²æ–°å¢ï¼', 'success');
            });

            updateOfferBtn.addEventListener('click', () => {
                const idToUpdate = parseInt(editOfferIdInput.value);
                const offerIndex = specialOffers.findIndex(offer => offer.id === idToUpdate);

                if (offerIndex === -1) {
                    showAdminMessageModal('æ›´æ–°éŒ¯èª¤', 'è«‹é¸æ“‡è¦æ›´æ–°çš„å„ªæƒ æ´»å‹•ã€‚', 'error');
                    return;
                }

                // Basic validation for required fields
                if (!offerNameInput.value || !offerDescriptionInput.value || !offerOriginalPriceInput.value || !offerSpecialPriceInput.value) {
                    showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å„ªæƒ æ´»å‹•æ¬„ä½ã€‚', 'error');
                    return;
                }

                // Create a new offer object with updated values and merge with the default schema
                const updatedOffer = window.OfferDataManager.mergeWithDefaultSchema([{
                    ...specialOffers[offerIndex], // Keep existing properties
                    name: offerNameInput.value,
                    description: offerDescriptionInput.value,
                    originalPrice: parseFloat(offerOriginalPriceInput.value) || 0,
                    specialPrice: parseFloat(offerSpecialPriceInput.value) || 0,
                    image: offerImageInput.value || specialOffers[offerIndex].image
                }], window.OfferDataManager.defaultOfferTemplate)[0]; // Ensure it merges with the template
                
                specialOffers[offerIndex] = updatedOffer; // Assign the merged and updated object back
                saveSpecialOffers();
                renderSpecialOffersAdmin();
                clearOfferForm();
                showAdminMessageModal('æˆåŠŸ', 'å„ªæƒ æ´»å‹•å·²æ›´æ–°ï¼', 'success');
            });

            clearOfferFormBtn.addEventListener('click', clearOfferForm);

            // Initial load for admin panel when opened
            loadCoffeeBeans(); // Coffee beans remain separate
            loadSpecialOffers(); // Now uses OfferDataManager
        });

        })(); // End IIFE
    </script>
</body>
</html>
