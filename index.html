<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Bean | 後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #fdfaf5; /* 溫暖米白 */
            --color-surface: #ffffff;
            --color-primary: #b58863; /* 柔和木質棕 */
            --color-secondary: #3f2e2e; /* 深咖啡文字 */
            --color-accent: #6b8e23; /* 橄欖綠 */
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-secondary);
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* 主內容區塊的最小高度，確保頁腳在底部 */
        main {
            flex-grow: 1;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #a07654;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: var(--color-secondary);
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #cccccc;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .table-header {
            background-color: var(--color-primary);
            color: white;
        }
        .table-row:nth-child(odd) {
            background-color: #f9f9f9;
        }
        .table-row:hover {
            background-color: #f0f0f0;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(181, 136, 99, 0.2);
            outline: none;
        }
        /* Custom Modal Styles */
        .admin-modal {
            display: flex; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .admin-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .admin-modal-content {
            background-color: var(--color-surface);
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .admin-modal.active .admin-modal-content {
            transform: translateY(0);
        }
        .admin-modal-close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }
        .admin-modal-close-button:hover,
        .admin-modal-close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .icon-success { color: var(--color-accent); }
        .icon-error { color: #ef4444; }
        .icon-info { color: var(--color-primary); }

        /* Stock indicator style */
        .stock-indicator {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85em;
        }
        .stock-in-stock {
            background-color: #d1fae5; /* Green-100 */
            color: #065f46; /* Green-800 */
        }
        .stock-low-stock {
            background-color: #fef3c7; /* Yellow-100 */
            color: #92400e; /* Yellow-800 */
        }
        .stock-out-of-stock {
            background-color: #fee2e2; /* Red-100 */
            color: #991b1b; /* Red-800 */
        }
    </style>
</head>
<body>
    <header class="bg-primary text-white p-4 shadow-md">
        <div class="container flex justify-between items-center">
            <h1 class="text-3xl font-bold">Melody Bean 後台管理</h1>
            <nav>
                <a href="展示.html" class="text-white hover:underline">返回前台</a>
            </nav>
        </div>
    </header>

    <main class="container py-8">
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-secondary mb-4">產品管理</h2>
            <div class="card">
                <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">品項名稱 <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700">國家 <span class="text-red-500">*</span></label>
                        <input type="text" id="country" name="country" required>
                    </div>
                    <div>
                        <label for="variety" class="block text-sm font-medium text-gray-700">品種 <span class="text-red-500">*</span></label>
                        <input type="text" id="variety" name="variety" required>
                    </div>
                    <div>
                        <label for="processing" class="block text-sm font-medium text-gray-700">處理法 <span class="text-red-500">*</span></label>
                        <input type="text" id="processing" name="processing" required>
                    </div>
                    <div>
                        <label for="altitude" class="block text-sm font-medium text-gray-700">海拔 (公尺)</label>
                        <input type="text" id="altitude" name="altitude">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-700">重量 (克) <span class="text-red-500">*</span></label>
                        <input type="text" id="weight" name="weight" required>
                    </div>
                    <div>
                        <label for="roast" class="block text-sm font-medium text-gray-700">烘焙度 <span class="text-red-500">*</span></label>
                        <select id="roast" name="roast" required>
                            <option value="">請選擇</option>
                            <option value="淺焙">淺焙</option>
                            <option value="中淺焙">中淺焙</option>
                            <option value="中焙">中焙</option>
                            <option value="中深焙">中深焙</option>
                            <option value="深焙">深焙</option>
                        </select>
                    </div>
                    <div>
                        <label for="expiry" class="block text-sm font-medium text-gray-700">期限 <span class="text-red-500">*</span></label>
                        <input type="date" id="expiry" name="expiry" required>
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">售價 (NT$) <span class="text-red-500">*</span></label>
                        <input type="number" id="price" name="price" required min="0" step="1">
                    </div>
                    <div>
                        <label for="stock" class="block text-sm font-medium text-gray-700">庫存 <span class="text-red-500">*</span></label>
                        <input type="number" id="stock" name="stock" required min="0" step="1">
                    </div>
                    <div class="md:col-span-2">
                        <label for="flavor" class="block text-sm font-medium text-gray-700">風味描述 <span class="text-red-500">*</span></label>
                        <textarea id="flavor" name="flavor" rows="3" required></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="farm_or_station" class="block text-sm font-medium text-gray-700">處理場/莊園</label>
                        <input type="text" id="farm_or_station" name="farm_or_station">
                    </div>
                    <div class="md:col-span-2">
                        <label for="lifestyle" class="block text-sm font-medium text-gray-700">生活提案</label>
                        <textarea id="lifestyle" name="lifestyle" rows="3"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">風味圖譜 (0-5)</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div>
                                <label for="profile-bitter" class="block text-xs font-medium text-gray-600">苦味</label>
                                <input type="number" id="profile-bitter" name="profile-bitter" min="0" max="5" step="0.1" value="2.5">
                            </div>
                            <div>
                                <label for="profile-acidity" class="block text-xs font-medium text-gray-600">酸度</label>
                                <input type="number" id="profile-acidity" name="profile-acidity" min="0" max="5" step="0.1" value="2.5">
                            </div>
                            <div>
                                <label for="profile-body" class="block text-xs font-medium text-gray-600">醇厚度</label>
                                <input type="number" id="profile-body" name="profile-body" min="0" max="5" step="0.1" value="2.5">
                            </div>
                            <div>
                                <label for="profile-floral" class="block text-xs font-medium text-gray-600">花果香</label>
                                <input type="number" id="profile-floral" name="profile-floral" min="0" max="5" step="0.1" value="2.5">
                            </div>
                            <div>
                                <label for="profile-nutty" class="block text-xs font-medium text-gray-600">堅果/巧克力</label>
                                <input type="number" id="profile-nutty" name="profile-nutty" min="0" max="5" step="0.1" value="2.5">
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                        <button type="submit" id="save-product-btn" class="px-6 py-3 rounded-md btn-primary">新增/更新品項</button>
                        <button type="button" id="clear-form-btn" class="px-6 py-3 rounded-md btn-secondary">清除表單</button>
                    </div>
                </form>
                <div class="md:col-span-2 flex justify-center mt-6">
                    <button type="button" id="load-sample-products-btn" class="px-6 py-3 rounded-md bg-green-600 text-white hover:bg-green-700 transition-colors">
                        <i class="fas fa-seedling mr-2"></i> 載入預設咖啡豆品項
                    </button>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-semibold text-secondary mb-4">現有品項列表</h2>
            <div class="card overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left table-header rounded-tl-lg">品項名稱</th>
                            <th class="py-3 px-4 text-left table-header">國家</th>
                            <th class="py-3 px-4 text-left table-header">品種</th>
                            <th class="py-3 px-4 text-left table-header">烘焙度</th>
                            <th class="py-3 px-4 text-left table-header">售價</th>
                            <th class="py-3 px-4 text-left table-header">庫存</th>
                            <th class="py-3 px-4 text-left table-header rounded-tr-lg">操作</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Products will be loaded here by JavaScript -->
                        <tr><td colspan="7" class="text-center py-4 text-gray-500">載入品項中...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="bg-secondary text-white py-4 mt-8">
        <div class="container text-center text-gray-300">
            <p>&copy; 2024 Melody Bean. All rights reserved.</p>
        </div>
    </footer>

    <!-- Custom Message Modal -->
    <div id="adminMessageModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-modal-close-button" onclick="closeAdminMessageModal()">&times;</span>
            <div id="modalIcon" class="modal-icon"></div>
            <h3 id="modalTitle" class="text-2xl font-semibold mb-4"></h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <button onclick="closeAdminMessageModal()" class="px-6 py-2 rounded-md btn-primary">確認</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let productsCollectionRef;
        let currentEditingProductId = null; // To store the ID of the product being edited
        let globalProductsData = []; // To store all products for easy lookup

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Function to show custom modal messages
        function showAdminMessageModal(title, message, type = 'info') {
            const modal = document.getElementById('adminMessageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');

            // Reset classes
            modalTitle.className = 'text-2xl font-semibold mb-4';
            modalIcon.className = 'modal-icon';

            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML to allow for basic HTML tags if needed

            // Set icon and title color based on type
            switch (type) {
                case 'success':
                    modalIcon.innerHTML = '<i class="fas fa-check-circle icon-success"></i>';
                    modalTitle.style.color = 'var(--color-accent)'; // Green
                    break;
                case 'error':
                    modalIcon.innerHTML = '<i class="fas fa-times-circle icon-error"></i>';
                    modalTitle.style.color = '#ef4444'; // Red
                    break;
                case 'info':
                default:
                    modalIcon.innerHTML = '<i class="fas fa-info-circle icon-info"></i>';
                    modalTitle.style.color = 'var(--color-primary)'; // Primary color
                    break;
            }
            modal.classList.add('active');
        }

        // Function to close the custom modal
        window.closeAdminMessageModal = function() {
            document.getElementById('adminMessageModal').classList.remove('active');
        };

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("[Firebase] Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("[Firebase] Signed in anonymously.");
                }

                const userId = auth.currentUser?.uid || 'anonymous';
                productsCollectionRef = collection(db, `artifacts/${appId}/public/data/coffeeProducts`);
                console.log("[Firebase] Firestore initialized. App ID:", appId, "User ID:", userId);

                // Listen for real-time updates to the products collection
                listenToProducts();

            } catch (error) {
                console.error("Firebase initialization error:", error);
                showAdminMessageModal('初始化錯誤', `Firebase 初始化失敗：${error.message}。請檢查您的 Firebase 設定。`, 'error');
            }
        }

        // Listen for real-time updates to the products collection
        function listenToProducts() {
            if (!productsCollectionRef) {
                console.error("productsCollectionRef is not initialized.");
                return;
            }
            const q = query(productsCollectionRef, orderBy('name')); // Order by name for consistent display

            onSnapshot(q, (snapshot) => {
                globalProductsData = []; // Clear previous data
                const productsTableBody = document.getElementById('products-table-body');
                productsTableBody.innerHTML = ''; // Clear table
                if (snapshot.empty) {
                    productsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">目前沒有咖啡豆品項。</td></tr>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const product = { id: doc.id, ...doc.data() };
                    globalProductsData.push(product); // Store product data
                    renderProductRow(product);
                });
                console.log("[Firestore] Products updated:", globalProductsData.length);
            }, (error) => {
                console.error("Error listening to products:", error);
                showAdminMessageModal('資料載入錯誤', `無法載入咖啡豆資料：${error.message}`, 'error');
            });
        }

        // Render a single product row in the table
        function renderProductRow(product) {
            const productsTableBody = document.getElementById('products-table-body');
            const row = productsTableBody.insertRow();
            row.id = `product-row-${product.id}`;
            row.className = 'table-row';

            const stockStatusClass = product.stock > 50 ? 'stock-in-stock' : (product.stock > 0 ? 'stock-low-stock' : 'stock-out-of-stock');
            const stockStatusText = product.stock > 50 ? '充足' : (product.stock > 0 ? '緊張' : '售罄');

            row.innerHTML = `
                <td class="py-3 px-4">${product.name || 'N/A'}</td>
                <td class="py-3 px-4">${product.country || 'N/A'}</td>
                <td class="py-3 px-4">${product.variety || 'N/A'}</td>
                <td class="py-3 px-4">${product.roast || 'N/A'}</td>
                <td class="py-3 px-4">NT$${product.price !== undefined ? product.price : 'N/A'}</td>
                <td class="py-3 px-4">
                    ${product.stock !== undefined ? product.stock : 'N/A'} 
                    <span class="stock-indicator ${stockStatusClass}">${stockStatusText}</span>
                </td>
                <td class="py-3 px-4 space-x-2">
                    <button class="px-3 py-1 rounded-md bg-blue-500 text-white text-sm hover:bg-blue-600 edit-btn" data-id="${product.id}">編輯</button>
                    <button class="px-3 py-1 rounded-md btn-danger text-sm hover:bg-red-600 delete-btn" data-id="${product.id}">刪除</button>
                </td>
            `;

            // Add event listeners for edit and delete buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editProduct(product.id));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteProduct(product.id));
        }

        // Clear form fields
        function clearForm() {
            document.getElementById('product-form').reset();
            document.getElementById('save-product-btn').textContent = '新增品項';
            currentEditingProductId = null;
            // Reset flavor profile to default 2.5s (0-5 scale)
            document.getElementById('profile-bitter').value = 2.5;
            document.getElementById('profile-acidity').value = 2.5;
            document.getElementById('profile-body').value = 2.5;
            document.getElementById('profile-floral').value = 2.5;
            document.getElementById('profile-nutty').value = 2.5;
        }

        // Populate form for editing
        function editProduct(id) {
            const product = globalProductsData.find(p => p.id === id);
            if (product) {
                document.getElementById('name').value = product.name || '';
                document.getElementById('country').value = product.country || '';
                document.getElementById('variety').value = product.variety || '';
                document.getElementById('processing').value = product.processing || '';
                document.getElementById('altitude').value = product.altitude || '';
                document.getElementById('weight').value = product.weight || '';
                document.getElementById('roast').value = product.roast || '';
                document.getElementById('expiry').value = product.expiry || ''; // Date input expectsYYYY-MM-DD
                document.getElementById('price').value = product.price !== undefined ? product.price : '';
                document.getElementById('stock').value = product.stock !== undefined ? product.stock : '';
                document.getElementById('flavor').value = product.flavor || '';
                document.getElementById('farm_or_station').value = product.farm_or_station || '';
                document.getElementById('lifestyle').value = product.lifestyle || '';

                // Set flavor profile values (convert from 0-100 to 0-5 for display in the form)
                if (Array.isArray(product.profile) && product.profile.length === 5) {
                    document.getElementById('profile-bitter').value = (product.profile[0] / 20).toFixed(1);
                    document.getElementById('profile-acidity').value = (product.profile[1] / 20).toFixed(1);
                    document.getElementById('profile-body').value = (product.profile[2] / 20).toFixed(1);
                    document.getElementById('profile-floral').value = (product.profile[3] / 20).toFixed(1);
                    document.getElementById('profile-nutty').value = (product.profile[4] / 20).toFixed(1);
                } else {
                    // Reset to default if profile is missing or malformed
                    document.getElementById('profile-bitter').value = 2.5;
                    document.getElementById('profile-acidity').value = 2.5;
                    document.getElementById('profile-body').value = 2.5;
                    document.getElementById('profile-floral').value = 2.5;
                    document.getElementById('profile-nutty').value = 2.5;
                }

                document.getElementById('save-product-btn').textContent = '更新品項';
                currentEditingProductId = id;
            }
        }

        // Delete a product
        async function deleteProduct(id) {
            // Use custom modal for confirmation instead of window.confirm
            showAdminMessageModal('確認刪除', '您確定要刪除這個品項嗎？此操作無法復原。', 'info');
            // Add a specific confirm button to the modal for deletion
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '確認刪除';
            confirmBtn.className = 'px-6 py-2 rounded-md btn-danger mt-4 mr-2';
            confirmBtn.onclick = async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/coffeeProducts`, id));
                    showAdminMessageModal('刪除成功', '品項已成功刪除！', 'success');
                    clearForm(); // Clear form after deletion
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showAdminMessageModal('刪除失敗', `刪除品項失敗：${error.message}`, 'error');
                } finally {
                    closeAdminMessageModal(); // Close the confirmation modal
                }
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.className = 'px-6 py-2 rounded-md btn-secondary mt-4';
            cancelBtn.onclick = () => closeAdminMessageModal();

            const modalContent = document.getElementById('adminMessageModal').querySelector('.admin-modal-content');
            const existingConfirmBtn = modalContent.querySelector('.btn-primary'); // Get the default confirm button
            existingConfirmBtn.style.display = 'none'; // Hide default button

            // Remove previous confirm/cancel buttons if any before adding new ones
            const oldConfirmBtn = modalContent.querySelector('.btn-danger');
            const oldCancelBtn = modalContent.querySelector('.btn-secondary');
            if (oldConfirmBtn) oldConfirmBtn.remove();
            if (oldCancelBtn) oldCancelBtn.remove();
            
            modalContent.appendChild(confirmBtn);
            modalContent.appendChild(cancelBtn);
        }

        // Define sample products data (converted to 0-100 scale for storage in Firestore)
        const sampleProducts = [
            {
                name: "衣索比亞 GEISHA 水洗 (114g)",
                country: "衣索比亞",
                variety: "GEISHA",
                processing: "水洗",
                altitude: "N/A",
                weight: "114克",
                roast: "淺焙",
                expiry: "2025-10-12", //YYYY-MM-DD format for date input
                price: 280,
                stock: 100,
                flavor: "接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬、百香果",
                farm_or_station: "N/A",
                lifestyle: "適合早晨提神，享受清新花果香，搭配輕食或獨自品味。",
                profile: [20, 45, 30, 42.5, 25] // Converted from 0-5 to 0-100 for storage (e.g., 1 -> 20, 2.5 -> 50, 4.5 -> 90)
            },
            {
                name: "衣索比亞 Heirloom 雙重厭氧水洗 (227g)",
                country: "衣索比亞",
                variety: "Heirloom",
                processing: "雙重厭氧水洗",
                altitude: "2000-2100公尺",
                weight: "227克",
                roast: "淺焙",
                expiry: "2025-10-28",
                price: 600,
                stock: 100,
                flavor: "茉莉、橙花、蜂蜜、水蜜桃",
                farm_or_station: "N/A",
                lifestyle: "適合午後放鬆，感受獨特發酵香氣與甜感，搭配甜點或閱讀。",
                profile: [15, 40, 35, 47.5, 30] // Converted from 0-5 to 0-100 for storage
            },
            {
                name: "衣索比亞 Heirloom 雙重厭氧水洗 (227g) - 批次2",
                country: "衣索比亞",
                variety: "Heirloom",
                processing: "雙重厭氧水洗",
                altitude: "2000-2100公尺",
                weight: "227克",
                roast: "淺焙",
                expiry: "2025-10-31",
                price: 600,
                stock: 100,
                flavor: "茉莉、橙花、蜂蜜、水蜜桃",
                farm_or_station: "N/A",
                lifestyle: "適合午後放鬆，感受獨特發酵香氣與甜感，搭配甜點或閱讀。",
                profile: [15, 40, 35, 47.5, 30] // Converted from 0-5 to 0-100 for storage
            },
            {
                name: "衣索比亞 GEISHA (227g)",
                country: "衣索比亞",
                variety: "GEISHA",
                processing: "日曬", // Added a default processing
                altitude: "N/A",
                weight: "227克",
                roast: "中淺焙",
                expiry: "2025-11-01",
                price: 540,
                stock: 100,
                flavor: "接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬",
                farm_or_station: "N/A",
                lifestyle: "適合日常品飲，風味平衡，可搭配多種餐點或單獨享用。",
                profile: [25, 35, 37.5, 40, 32.5] // Converted from 0-5 to 0-100 for storage
            },
            {
                name: "衣索比亞 GEISHA 水洗 (227g) - 批次2",
                country: "衣索比亞",
                variety: "GEISHA",
                processing: "水洗",
                altitude: "2280公尺",
                weight: "227克",
                roast: "中淺焙",
                expiry: "2025-11-01",
                price: 540,
                stock: 100,
                flavor: "接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬",
                farm_or_station: "N/A",
                lifestyle: "適合日常品飲，風味平衡，可搭配多種餐點或單獨享用。",
                profile: [25, 35, 37.5, 40, 32.5] // Converted from 0-5 to 0-100 for storage
            },
            { // Item 6 is missing from user input, skipping to 7
                name: "衣索比亞 綜合批次 (227g)",
                country: "衣索比亞",
                variety: "原生種", // Added a default variety
                processing: "日曬", // Added a default processing
                altitude: "N/A",
                weight: "227克",
                roast: "淺焙",
                expiry: "2025-11-01",
                price: 540,
                stock: 100,
                flavor: "接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬",
                farm_or_station: "N/A",
                lifestyle: "適合探索多樣風味，體驗衣索比亞咖啡的豐富層次。",
                profile: [22.5, 42.5, 32.5, 45, 27.5] // Converted from 0-5 to 0-100 for storage
            },
            {
                name: "哥斯大黎加 Geisha 白蜜 (114g)",
                country: "哥斯大黎加",
                variety: "Geisha（藝妓）",
                processing: "白蜜",
                altitude: "1950公尺",
                weight: "114克",
                roast: "淺焙",
                expiry: "2025-08-15",
                price: 800,
                stock: 100,
                flavor: "百合花、野薑花、檸檬草、柑橘、紅色莓果、蜂蜜",
                farm_or_station: "聖伊西多羅",
                lifestyle: "適合特殊時刻，細細品味其優雅的花香與甜感，是品鑑級的享受。",
                profile: [17.5, 47.5, 35, 45, 20] // Converted from 0-5 to 0-100 for storage
            },
            {
                name: "哥斯大黎加 Geisha 白蜜 (227g)",
                country: "哥斯大黎加",
                variety: "Geisha（藝妓）",
                processing: "白蜜",
                altitude: "1950公尺",
                weight: "227克",
                roast: "淺焙",
                expiry: "2025-08-15",
                price: 1800,
                stock: 100,
                flavor: "百合花、野薑花、檸檬草、柑橘、紅色莓果、蜂蜜",
                farm_or_station: "聖伊西多羅",
                lifestyle: "適合特殊時刻，細細品味其優雅的花香與甜感，是品鑑級的享受。",
                profile: [17.5, 47.5, 35, 45, 20] // Converted from 0-5 to 0-100 for storage
            }
        ];

        // Function to load all sample products into Firestore
        async function loadSampleProducts() {
            // Use custom modal for confirmation
            showAdminMessageModal('確認載入預設品項', '這將會新增多個預設咖啡豆品項到您的資料庫中。您確定要繼續嗎？', 'info');
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '確認載入';
            confirmBtn.className = 'px-6 py-2 rounded-md btn-primary mt-4 mr-2';
            confirmBtn.onclick = async () => {
                closeAdminMessageModal(); // Close confirmation modal immediately

                let successCount = 0;
                let errorCount = 0;
                const results = [];

                for (const product of sampleProducts) {
                    try {
                        const productData = {
                            name: product.name,
                            country: product.country,
                            variety: product.variety,
                            processing: product.processing,
                            altitude: product.altitude,
                            weight: product.weight,
                            roast: product.roast,
                            expiry: product.expiry,
                            price: parseFloat(product.price),
                            stock: parseInt(product.stock),
                            flavor: product.flavor,
                            farm_or_station: product.farm_or_station || 'N/A',
                            lifestyle: product.lifestyle || 'N/A',
                            // Store profile as 0-100 in Firestore
                            profile: product.profile || [50, 50, 50, 50, 50] 
                        };
                        await addDoc(productsCollectionRef, productData);
                        results.push(`<li>成功新增：${product.name}</li>`);
                        successCount++;
                    } catch (error) {
                        results.push(`<li class="text-red-500">新增失敗：${product.name} (${error.message})</li>`);
                        errorCount++;
                        console.error(`Error adding sample product ${product.name}:`, error);
                    }
                }
                showAdminMessageModal('載入完成', `成功新增 ${successCount} 個品項，失敗 ${errorCount} 個品項。<ul class="list-disc list-inside mt-2 text-left">${results.join('')}</ul>`, successCount > 0 ? 'success' : 'error');
                // Restore default modal button
                const modalContent = document.getElementById('adminMessageModal').querySelector('.admin-modal-content');
                modalContent.querySelector('.btn-primary').style.display = 'block';
                const oldConfirmBtn = modalContent.querySelector('.btn-primary.mt-4'); // This might be the new one, need to be careful
                const oldCancelBtn = modalContent.querySelector('.btn-secondary.mt-4');
                if (oldConfirmBtn) oldConfirmBtn.remove();
                if (oldCancelBtn) oldCancelBtn.remove();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.className = 'px-6 py-2 rounded-md btn-secondary mt-4';
            cancelBtn.onclick = () => closeAdminMessageModal();

            const modalContent = document.getElementById('adminMessageModal').querySelector('.admin-modal-content');
            const existingConfirmBtn = modalContent.querySelector('.btn-primary');
            existingConfirmBtn.style.display = 'none';

            // Remove previous confirm/cancel buttons if any before adding new ones
            const oldConfirmBtn = modalContent.querySelector('.btn-primary.mt-4.mr-2'); // Specific class to target the added one
            const oldCancelBtn = modalContent.querySelector('.btn-secondary.mt-4');
            if (oldConfirmBtn) oldConfirmBtn.remove();
            if (oldCancelBtn) oldCancelBtn.remove();

            modalContent.appendChild(confirmBtn);
            modalContent.appendChild(cancelBtn);
        }


        // Event listener for form submission (Add/Update Product)
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                name: document.getElementById('name').value,
                country: document.getElementById('country').value,
                variety: document.getElementById('variety').value,
                processing: document.getElementById('processing').value,
                altitude: document.getElementById('altitude').value,
                weight: document.getElementById('weight').value,
                roast: document.getElementById('roast').value,
                expiry: document.getElementById('expiry').value, //YYYY-MM-DD format
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
                flavor: document.getElementById('flavor').value,
                farm_or_station: document.getElementById('farm_or_station').value,
                lifestyle: document.getElementById('lifestyle').value,
                // Convert profile values from 0-5 to 0-100 for storage in Firestore
                profile: [
                    parseFloat(document.getElementById('profile-bitter').value) * 20,
                    parseFloat(document.getElementById('profile-acidity').value) * 20,
                    parseFloat(document.getElementById('profile-body').value) * 20,
                    parseFloat(document.getElementById('profile-floral').value) * 20,
                    parseFloat(document.getElementById('profile-nutty').value) * 20
                ]
            };

            // Basic validation
            if (!productData.name || !productData.country || !productData.variety || !productData.processing ||
                !productData.weight || !productData.roast || !productData.expiry || isNaN(productData.price) || isNaN(productData.stock) || !productData.flavor) {
                showAdminMessageModal('輸入錯誤', '請填寫所有標記 <span class="text-red-500">*</span> 的必填欄位，並確保價格和庫存為有效數字。', 'error');
                return;
            }

            try {
                if (currentEditingProductId) {
                    // Update existing product
                    const docRef = doc(db, `artifacts/${appId}/public/data/coffeeProducts`, currentEditingProductId);
                    await updateDoc(docRef, productData);
                    showAdminMessageModal('更新成功', `${productData.name} 已成功更新！`, 'success');
                } else {
                    // Add new product
                    await addDoc(productsCollectionRef, productData);
                    showAdminMessageModal('新增成功', `${productData.name} 已成功新增！`, 'success');
                }
                clearForm(); // Clear form after successful operation
            } catch (error) {
                console.error("Error saving product:", error);
                showAdminMessageModal('操作失敗', `儲存品項失敗：${error.message}`, 'error');
            }
        });

        // Event listener for Clear Form button
        document.getElementById('clear-form-btn').addEventListener('click', clearForm);

        // Event listener for Load Sample Products button
        document.getElementById('load-sample-products-btn').addEventListener('click', loadSampleProducts);

        // Initialize Firebase on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
