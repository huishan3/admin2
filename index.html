<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Bean | 後端管理介面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #b58863;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box; /* Ensures padding doesn't increase total width */
        }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-blue { background-color: #4299e1; }
        .btn-blue:hover { background-color: #3182ce; }
        .btn-green { background-color: #48bb78; }
        .btn-green:hover { background-color: #38a169; }
        .btn-purple { background-color: #805ad5; }
        .btn-purple:hover { background-color: #6b46c1; }
        .btn-yellow { background-color: #ecc94b; }
        .btn-yellow:hover { background-color: #d69e2e; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .card {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background-color: #fdfdfd;
        }
        .item-list li {
            background-color: #fdfaf5;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f0f0f0;
        }

        /* Custom Modal Styles */
        .admin-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        .admin-modal-close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .admin-modal-close-button:hover,
        .admin-modal-close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .admin-modal-success { color: #48bb78; } /* Green */
        .admin-modal-error { color: #ef4444; } /* Red */
    </style>
</head>
<body>
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold mb-8">Melody Bean 後端管理介面</h1>

        <section class="mb-12">
            <h2 class="text-3xl font-semibold mb-6">咖啡豆管理</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-4">現有咖啡豆列表</h3>
                <ul id="admin-coffee-list" class="item-list list-none pl-0 space-y-2 mb-4">
                    <!-- Coffee beans will be listed here -->
                </ul>
                <div class="flex gap-2 flex-wrap justify-center">
                    <button id="load-coffee-data" class="btn-blue">載入咖啡豆數據</button>
                    <button id="save-coffee-data" class="btn-green">儲存咖啡豆數據</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">新增 / 編輯咖啡豆</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="hidden" id="edit-coffee-id">
                    <input type="text" id="coffee-name" placeholder="名稱 * (必填)" class="p-2 border rounded-md" required>
                    <input type="text" id="coffee-country" placeholder="國家" class="p-2 border rounded-md">
                    <input type="text" id="coffee-variety" placeholder="品種" class="p-2 border rounded-md">
                    <input type="text" id="coffee-flavor" placeholder="風味描述 * (必填)" class="p-2 border rounded-md" required>
                    <select id="coffee-roast" class="p-2 border rounded-md" required>
                        <option value="" disabled selected>烘焙度 * (必填)</option>
                        <option value="淺焙">淺焙</option>
                        <option value="中淺焙">中淺焙</option>
                        <option value="中焙">中焙</option>
                        <option value="中深焙">中深焙</option>
                        <option value="深焙">深焙</option>
                    </select>
                    <input type="text" id="coffee-weight" placeholder="重量 * (例如: 114g, 227g)" class="p-2 border rounded-md" required>
                    <input type="number" id="coffee-price" placeholder="售價 * (請輸入純數字，例如: 280)" class="p-2 border rounded-md" required min="0">
                    <input type="date" id="coffee-expiry" placeholder="期限 (YYYY-MM-DD)" class="p-2 border rounded-md">
                    <input type="number" id="coffee-stock" placeholder="庫存數量 * (請輸入非負整數，例如: 10)" class="p-2 border rounded-md" required min="0">
                    <select id="coffee-category" class="p-2 border rounded-md">
                        <option value="" disabled selected>分類 (可選)</option>
                        <option value="light">淺焙類</option>
                        <option value="medium">中焙類</option>
                        <option value="dark">深焙類</option>
                    </select>
                    <input type="text" id="coffee-image" placeholder="圖片URL (可留空，使用預設圖片)" class="p-2 border rounded-md col-span-2">
                    <textarea id="coffee-lifestyle" placeholder="生活提案 (例如: 適合在靜謐的午後細細品味)" class="p-2 border rounded-md col-span-2"></textarea>
                    
                    <!-- Flavor Profile Inputs -->
                    <h4 class="col-span-2 text-md font-semibold mt-2">風味圖譜評分 (請輸入 0 到 5 之間的數字)</h4>
                    <input type="number" id="fp-acidity" placeholder="酸度 (0-5)" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-body" placeholder="醇厚度 (0-5)" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-sweetness" placeholder="甜度 (0-5)" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-aroma" placeholder="香氣 (0-5)" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-finish" placeholder="餘韻 (0-5)" min="0" max="5" class="p-2 border rounded-md">
                </div>
                <div class="flex gap-2 flex-wrap justify-center">
                    <button id="add-coffee" class="btn-purple">新增咖啡豆</button>
                    <button id="update-coffee" class="btn-yellow">更新選定咖啡豆</button>
                    <button id="clear-coffee-form" class="btn-blue">清除表單</button>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-3xl font-semibold mb-6">優惠活動管理</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-4">現有優惠活動列表</h3>
                <ul id="admin-offer-list" class="item-list list-none pl-0 space-y-2 mb-4">
                    <!-- Offers will be listed here -->
                </ul>
                <div class="flex gap-2 flex-wrap justify-center">
                    <button id="load-offer-data" class="btn-blue">載入優惠數據</button>
                    <button id="save-offer-data" class="btn-green">儲存優惠數據</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">新增 / 編輯優惠</h3>
                <input type="hidden" id="edit-offer-id">
                <input type="text" id="offer-name" placeholder="名稱 * (必填)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="text" id="offer-description" placeholder="描述 * (必填)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="number" id="offer-original-price" placeholder="原價 * (請輸入純數字，例如: 1000)" class="p-2 border rounded-md w-full mb-2" required min="0">
                <input type="number" id="offer-special-price" placeholder="特價 * (請輸入純數字，例如: 800)" class="p-2 border rounded-md w-full mb-4" required min="0">
                <input type="text" id="offer-image" placeholder="圖片URL (可留空，使用預設圖片)" class="p-2 border rounded-md w-full mb-4">
                <div class="flex gap-2 flex-wrap justify-center">
                    <button id="add-offer" class="btn-purple">新增優惠</button>
                    <button id="update-offer" class="btn-yellow">更新選定優惠</button>
                    <button id="clear-offer-form" class="btn-blue">清除表單</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Custom Message Modal -->
    <div id="adminMessageModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-modal-close-button" onclick="closeAdminMessageModal()">&times;</span>
            <h3 id="adminModalTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="adminModalMessage" class="text-gray-700 mb-6"></p>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md" onclick="closeAdminMessageModal()">確定</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Local Storage Keys ---
            const COFFEE_BEANS_KEY = 'melodyCoffeeBeans';
            const SPECIAL_OFFERS_KEY = 'melodySpecialOffers';

            // --- Default Data (Hardcoded for initial setup if localStorage is empty) ---
            const defaultCoffeeBeans = [
                { id: 1, name: 'GEISHA 水洗（114g）', country: '衣索比亞', variety: 'GEISHA 水洗', flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬、百香果', roast: '淺焙', weight: '114g', expiryDate: '2025-10-12', price: 280, stock: 10, category: 'light', image: './image/image_1.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: '這款咖啡充滿複雜的香氣與明亮的風味，適合在靜謐的午後細細品味，或搭配輕盈的甜點。' },
                { id: 2, name: 'Heirloom 雙重厭氧（227g）- 批次A', country: '衣索比亞', variety: 'Heirloom', flavor: '茉莉、橙花、蜂蜜、水蜜桃', roast: '淺焙', weight: '227g', expiryDate: '2025-10-28', price: 600, stock: 5, category: 'light', image: './image/image_2.png', flavorProfile: { acidity: 4, body: 3, sweetness: 5, aroma: 5, finish: 4 }, lifestyle: '甜美而豐富的口感，是開啟美好一天的理想選擇，與早餐糕點搭配尤佳。' },
                { id: 3, name: 'Heirloom 雙重厭氧（227g）- 批次B', country: '衣索比亞', variety: 'Heirloom', flavor: '茉莉、橙花、蜂蜜、水蜜桃', roast: '淺焙', weight: '227g', expiryDate: '2025-10-31', price: 600, stock: 8, category: 'light', image: './image/image_3.png', flavorProfile: { acidity: 4, body: 3, sweetness: 5, aroma: 5, finish: 4 }, lifestyle: '相同的風味，不同的採收批次，確保每一杯都有始終如一的甜蜜與芬芳。' },
                { id: 4, name: 'GEISHA（227g）中淺焙', country: '衣索比亞', variety: 'GEISHA', flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬', roast: '中淺焙', weight: '227g', expiryDate: '2025-11-01', price: 540, stock: 12, category: 'medium', image: './image/image_4.png', flavorProfile: { acidity: 3, body: 3, sweetness: 3, aroma: 4, finish: 3 }, lifestyle: '平衡的風味與較低的酸度，適合日常飲用，無論是搭配閱讀或工作，都能帶來愉悅感受。' },
                { id: 5, name: 'GEISHA 水洗（227g）2280m', country: '衣索比亞', variety: 'GEISHA 水洗', flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬', roast: '淺焙', weight: '227g', expiryDate: '2025-11-05', price: 580, stock: 0, category: 'light', image: './image/image_5.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: '高海拔的獨特風味，帶來更為清新的口感與芬芳。' }
            ];

            const defaultSpecialOffers = [
                { id: 1, name: '週年慶限定優惠', description: '購買任兩包咖啡豆即享八折優惠！', originalPrice: 1000, specialPrice: 800, image: 'https://placehold.co/400x200/b58863/FFFFFF?text=Anniversary+Offer' },
                { id: 2, name: '新客體驗包', description: '首次購買即贈送精選濾掛包三入組。', originalPrice: 300, specialPrice: 250, image: 'https://placehold.co/400x200/6b8e23/FFFFFF?text=New+Customer+Offer' }
            ];

            let coffeeBeans = [];
            let specialOffers = [];

            // --- Elements ---
            const adminCoffeeList = document.getElementById('admin-coffee-list');
            const loadCoffeeDataBtn = document.getElementById('load-coffee-data');
            const saveCoffeeDataBtn = document.getElementById('save-coffee-data');
            const addCoffeeBtn = document.getElementById('add-coffee');
            const updateCoffeeBtn = document.getElementById('update-coffee');
            const clearCoffeeFormBtn = document.getElementById('clear-coffee-form');

            const coffeeNameInput = document.getElementById('coffee-name');
            const coffeeCountryInput = document.getElementById('coffee-country');
            const coffeeVarietyInput = document.getElementById('coffee-variety');
            const coffeeFlavorInput = document.getElementById('coffee-flavor');
            const coffeeRoastSelect = document.getElementById('coffee-roast');
            const coffeeWeightInput = document.getElementById('coffee-weight');
            const coffeePriceInput = document.getElementById('coffee-price');
            const coffeeExpiryInput = document.getElementById('coffee-expiry');
            const coffeeStockInput = document.getElementById('coffee-stock');
            const coffeeCategorySelect = document.getElementById('coffee-category');
            const coffeeImageInput = document.getElementById('coffee-image');
            const coffeeLifestyleInput = document.getElementById('coffee-lifestyle');
            const editCoffeeIdInput = document.getElementById('edit-coffee-id');

            const fpAcidityInput = document.getElementById('fp-acidity');
            const fpBodyInput = document.getElementById('fp-body');
            const fpSweetnessInput = document.getElementById('fp-sweetness');
            const fpAromaInput = document.getElementById('fp-aroma');
            const fpFinishInput = document.getElementById('fp-finish');

            const adminOfferList = document.getElementById('admin-offer-list');
            const loadOfferDataBtn = document.getElementById('load-offer-data');
            const saveOfferDataBtn = document.getElementById('save-offer-data');
            const addOfferBtn = document.getElementById('add-offer');
            const updateOfferBtn = document.getElementById('update-offer');
            const clearOfferFormBtnOffer = document.getElementById('clear-offer-form'); // Renamed to avoid conflict

            const offerNameInput = document.getElementById('offer-name');
            const offerDescriptionInput = document.getElementById('offer-description');
            const offerOriginalPriceInput = document.getElementById('offer-original-price');
            const offerSpecialPriceInput = document.getElementById('offer-special-price');
            const offerImageInput = document.getElementById('offer-image');
            const editOfferIdInput = document.getElementById('edit-offer-id');

            const adminMessageModal = document.getElementById('adminMessageModal');
            const adminModalTitle = document.getElementById('adminModalTitle');
            const adminModalMessage = document.getElementById('adminModalMessage');

            // --- Helper Functions ---
            function showAdminMessageModal(title, message, type) {
                adminModalTitle.textContent = title;
                adminModalMessage.textContent = message;
                adminModalTitle.className = 'text-2xl font-bold mb-4 ' + (type === 'success' ? 'admin-modal-success' : 'admin-modal-error');
                adminMessageModal.style.display = 'flex';
            }

            window.closeAdminMessageModal = function() {
                adminMessageModal.style.display = 'none';
            };

            function saveCoffeeBeans() {
                localStorage.setItem(COFFEE_BEANS_KEY, JSON.stringify(coffeeBeans));
                console.log('Coffee beans saved to localStorage.');
            }

            function loadCoffeeBeans() {
                const storedCoffeeBeans = localStorage.getItem(COFFEE_BEANS_KEY);
                if (storedCoffeeBeans) {
                    coffeeBeans = JSON.parse(storedCoffeeBeans);
                } else {
                    coffeeBeans = [...defaultCoffeeBeans];
                    saveCoffeeBeans(); // Save default data if not present
                }
                renderCoffeeBeansAdmin();
                console.log('Coffee beans loaded.');
            }

            function renderCoffeeBeansAdmin() {
                adminCoffeeList.innerHTML = '';
                coffeeBeans.forEach(bean => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    li.innerHTML = `
                        <span>${bean.name} (庫存: ${bean.stock}) - NT$${bean.price}</span>
                        <div>
                            <button data-id="${bean.id}" class="edit-coffee-btn btn-yellow text-sm py-1 px-2 mr-1">編輯</button>
                            <button data-id="${bean.id}" class="delete-coffee-btn btn-red text-sm py-1 px-2">刪除</button>
                        </div>
                    `;
                    adminCoffeeList.appendChild(li);
                });

                document.querySelectorAll('.edit-coffee-btn').forEach(button => {
                    button.onclick = (e) => editCoffee(parseInt(e.target.dataset.id));
                });
                document.querySelectorAll('.delete-coffee-btn').forEach(button => {
                    button.onclick = (e) => deleteCoffee(parseInt(e.target.dataset.id));
                });
            }

            function clearCoffeeForm() {
                editCoffeeIdInput.value = '';
                coffeeNameInput.value = '';
                coffeeCountryInput.value = '';
                coffeeVarietyInput.value = '';
                coffeeFlavorInput.value = '';
                coffeeRoastSelect.value = '';
                coffeeWeightInput.value = '';
                coffeePriceInput.value = '';
                coffeeExpiryInput.value = '';
                coffeeStockInput.value = '';
                coffeeCategorySelect.value = '';
                coffeeImageInput.value = '';
                coffeeLifestyleInput.value = '';
                fpAcidityInput.value = '';
                fpBodyInput.value = '';
                fpSweetnessInput.value = '';
                fpAromaInput.value = '';
                fpFinishInput.value = '';
            }

            function validateCoffeeForm(isAdd = true) {
                if (!coffeeNameInput.value.trim() || !coffeeFlavorInput.value.trim() || !coffeeRoastSelect.value.trim() || !coffeeWeightInput.value.trim() || coffeePriceInput.value.trim() === '' || coffeeStockInput.value.trim() === '') {
                    showAdminMessageModal('輸入錯誤', '請填寫所有標註為「必填」的咖啡豆欄位。', 'error');
                    return false;
                }

                const price = parseFloat(coffeePriceInput.value);
                if (isNaN(price) || price < 0) {
                    showAdminMessageModal('輸入錯誤', '售價請輸入非負數的純數字。', 'error');
                    return false;
                }

                const stock = parseInt(coffeeStockInput.value);
                if (isNaN(stock) || stock < 0) {
                    showAdminMessageModal('輸入錯誤', '庫存數量請輸入非負數的純整數。', 'error');
                    return false;
                }

                const acidity = parseFloat(fpAcidityInput.value);
                const body = parseFloat(fpBodyInput.value);
                const sweetness = parseFloat(fpSweetnessInput.value);
                const aroma = parseFloat(fpAromaInput.value);
                const finish = parseFloat(fpFinishInput.value);

                if ((fpAcidityInput.value !== '' && (isNaN(acidity) || acidity < 0 || acidity > 5)) ||
                    (fpBodyInput.value !== '' && (isNaN(body) || body < 0 || body > 5)) ||
                    (fpSweetnessInput.value !== '' && (isNaN(sweetness) || sweetness < 0 || sweetness > 5)) ||
                    (fpAromaInput.value !== '' && (isNaN(aroma) || aroma < 0 || aroma > 5)) ||
                    (fpFinishInput.value !== '' && (isNaN(finish) || finish < 0 || finish > 5))) {
                    showAdminMessageModal('輸入錯誤', '風味圖譜評分請輸入 0 到 5 之間的數字。', 'error');
                    return false;
                }
                return true;
            }


            function addCoffee() {
                if (!validateCoffeeForm(true)) {
                    return;
                }

                const newCoffee = {
                    id: coffeeBeans.length ? Math.max(...coffeeBeans.map(c => c.id)) + 1 : 1,
                    name: coffeeNameInput.value.trim(),
                    country: coffeeCountryInput.value.trim(),
                    variety: coffeeVarietyInput.value.trim(),
                    flavor: coffeeFlavorInput.value.trim(),
                    roast: coffeeRoastSelect.value.trim(),
                    weight: coffeeWeightInput.value.trim(),
                    price: parseFloat(coffeePriceInput.value),
                    expiryDate: coffeeExpiryInput.value.trim(),
                    stock: parseInt(coffeeStockInput.value),
                    category: coffeeCategorySelect.value.trim(),
                    image: coffeeImageInput.value.trim() || 'https://placehold.co/400x300/cccccc/333333?text=無圖片', // Default image
                    lifestyle: coffeeLifestyleInput.value.trim() || '',
                    flavorProfile: {
                        acidity: parseFloat(fpAcidityInput.value) || 0,
                        body: parseFloat(fpBodyInput.value) || 0,
                        sweetness: parseFloat(fpSweetnessInput.value) || 0,
                        aroma: parseFloat(fpAromaInput.value) || 0,
                        finish: parseFloat(fpFinishInput.value) || 0,
                    }
                };
                coffeeBeans.push(newCoffee);
                saveCoffeeBeans();
                renderCoffeeBeansAdmin();
                clearCoffeeForm();
                showAdminMessageModal('成功', '咖啡豆已新增！', 'success');
            }

            function editCoffee(id) {
                const coffee = coffeeBeans.find(c => c.id === id);
                if (coffee) {
                    editCoffeeIdInput.value = coffee.id;
                    coffeeNameInput.value = coffee.name;
                    coffeeCountryInput.value = coffee.country;
                    coffeeVarietyInput.value = coffee.variety;
                    coffeeFlavorInput.value = coffee.flavor;
                    coffeeRoastSelect.value = coffee.roast;
                    coffeeWeightInput.value = coffee.weight;
                    coffeePriceInput.value = coffee.price;
                    coffeeExpiryInput.value = coffee.expiryDate;
                    coffeeStockInput.value = coffee.stock;
                    coffeeCategorySelect.value = coffee.category;
                    coffeeImageInput.value = coffee.image;
                    coffeeLifestyleInput.value = coffee.lifestyle;
                    if (coffee.flavorProfile) {
                        fpAcidityInput.value = coffee.flavorProfile.acidity;
                        fpBodyInput.value = coffee.flavorProfile.body;
                        fpSweetnessInput.value = coffee.flavorProfile.sweetness;
                        fpAromaInput.value = coffee.flavorProfile.aroma;
                        fpFinishInput.value = coffee.flavorProfile.finish;
                    } else { // Clear if no flavor profile
                        fpAcidityInput.value = '';
                        fpBodyInput.value = '';
                        fpSweetnessInput.value = '';
                        fpAromaInput.value = '';
                        fpFinishInput.value = '';
                    }
                }
            }

            function updateCoffee() {
                const idToUpdate = parseInt(editCoffeeIdInput.value);
                if (isNaN(idToUpdate)) {
                    showAdminMessageModal('更新錯誤', '請選擇要更新的咖啡豆。', 'error');
                    return;
                }

                if (!validateCoffeeForm(false)) {
                    return;
                }

                const coffeeIndex = coffeeBeans.findIndex(bean => bean.id === idToUpdate);
                if (coffeeIndex === -1) {
                    showAdminMessageModal('更新錯誤', '未找到要更新的咖啡豆。', 'error');
                    return;
                }

                coffeeBeans[coffeeIndex] = {
                    ...coffeeBeans[coffeeIndex],
                    name: coffeeNameInput.value.trim(),
                    country: coffeeCountryInput.value.trim(),
                    variety: coffeeVarietyInput.value.trim(),
                    flavor: coffeeFlavorInput.value.trim(),
                    roast: coffeeRoastSelect.value.trim(),
                    weight: coffeeWeightInput.value.trim(),
                    price: parseFloat(coffeePriceInput.value),
                    expiryDate: coffeeExpiryInput.value.trim(),
                    stock: parseInt(coffeeStockInput.value),
                    category: coffeeCategorySelect.value.trim(),
                    image: coffeeImageInput.value.trim() || coffeeBeans[coffeeIndex].image, // Keep existing image if new is empty
                    lifestyle: coffeeLifestyleInput.value.trim(),
                    flavorProfile: {
                        acidity: parseFloat(fpAcidityInput.value) || 0,
                        body: parseFloat(fpBodyInput.value) || 0,
                        sweetness: parseFloat(fpSweetnessInput.value) || 0,
                        aroma: parseFloat(fpAromaInput.value) || 0,
                        finish: parseFloat(fpFinishInput.value) || 0,
                    }
                };
                saveCoffeeBeans();
                renderCoffeeBeansAdmin();
                clearCoffeeForm();
                showAdminMessageModal('成功', '咖啡豆已更新！', 'success');
            }

            function deleteCoffee(id) {
                if (confirm('確定要刪除這款咖啡豆嗎？')) { // Using browser confirm for simplicity in admin panel
                    coffeeBeans = coffeeBeans.filter(bean => bean.id !== id);
                    saveCoffeeBeans();
                    renderCoffeeBeansAdmin();
                    clearCoffeeForm();
                    showAdminMessageModal('成功', '咖啡豆已刪除！', 'success');
                }
            }

            // --- Special Offers Functions ---
            function saveSpecialOffers() {
                localStorage.setItem(SPECIAL_OFFERS_KEY, JSON.stringify(specialOffers));
                console.log('Special offers saved to localStorage.');
            }

            function loadSpecialOffers() {
                const storedOffers = localStorage.getItem(SPECIAL_OFFERS_KEY);
                if (storedOffers) {
                    specialOffers = JSON.parse(storedOffers);
                } else {
                    specialOffers = [...defaultSpecialOffers];
                    saveSpecialOffers(); // Save default data if not present
                }
                renderSpecialOffersAdmin();
                console.log('Special offers loaded.');
            }

            function renderSpecialOffersAdmin() {
                adminOfferList.innerHTML = '';
                specialOffers.forEach(offer => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    li.innerHTML = `
                        <span>${offer.name} - NT$${offer.specialPrice} (原價: NT$${offer.originalPrice})</span>
                        <div>
                            <button data-id="${offer.id}" class="edit-offer-btn btn-yellow text-sm py-1 px-2 mr-1">編輯</button>
                            <button data-id="${offer.id}" class="delete-offer-btn btn-red text-sm py-1 px-2">刪除</button>
                        </div>
                    `;
                    adminOfferList.appendChild(li);
                });

                document.querySelectorAll('.edit-offer-btn').forEach(button => {
                    button.onclick = (e) => editSpecialOffer(parseInt(e.target.dataset.id));
                });
                document.querySelectorAll('.delete-offer-btn').forEach(button => {
                    button.onclick = (e) => deleteSpecialOffer(parseInt(e.target.dataset.id));
                });
            }

            function clearOfferForm() {
                editOfferIdInput.value = '';
                offerNameInput.value = '';
                offerDescriptionInput.value = '';
                offerOriginalPriceInput.value = '';
                offerSpecialPriceInput.value = '';
                offerImageInput.value = '';
            }

            function validateOfferForm(isAdd = true) {
                if (!offerNameInput.value.trim() || !offerDescriptionInput.value.trim() || offerOriginalPriceInput.value.trim() === '' || offerSpecialPriceInput.value.trim() === '') {
                    showAdminMessageModal('輸入錯誤', '請填寫所有標註為「必填」的優惠活動欄位。', 'error');
                    return false;
                }

                const originalPrice = parseFloat(offerOriginalPriceInput.value);
                const specialPrice = parseFloat(offerSpecialPriceInput.value);

                if (isNaN(originalPrice) || originalPrice < 0 || isNaN(specialPrice) || specialPrice < 0) {
                    showAdminMessageModal('輸入錯誤', '原價和特價請輸入非負數的純數字。', 'error');
                    return false;
                }

                if (specialPrice > originalPrice) {
                    showAdminMessageModal('輸入錯誤', '特價不能高於原價。', 'error');
                    return false;
                }
                return true;
            }

            function addSpecialOffer() {
                if (!validateOfferForm(true)) {
                    return;
                }

                const newOffer = {
                    id: specialOffers.length ? Math.max(...specialOffers.map(o => o.id)) + 1 : 1,
                    name: offerNameInput.value.trim(),
                    description: offerDescriptionInput.value.trim(),
                    originalPrice: parseFloat(offerOriginalPriceInput.value),
                    specialPrice: parseFloat(offerSpecialPriceInput.value),
                    image: offerImageInput.value.trim() || 'https://placehold.co/400x200/cccccc/333333?text=無圖片' // Default image
                };
                specialOffers.push(newOffer);
                saveSpecialOffers();
                renderSpecialOffersAdmin();
                clearOfferForm();
                showAdminMessageModal('成功', '優惠活動已新增！', 'success');
            }

            function editSpecialOffer(id) {
                const offer = specialOffers.find(o => o.id === id);
                if (offer) {
                    editOfferIdInput.value = offer.id;
                    offerNameInput.value = offer.name;
                    offerDescriptionInput.value = offer.description;
                    offerOriginalPriceInput.value = offer.originalPrice;
                    offerSpecialPriceInput.value = offer.specialPrice;
                    offerImageInput.value = offer.image;
                }
            }

            function deleteSpecialOffer(id) {
                if (confirm('確定要刪除這項優惠活動嗎？')) { // Using browser confirm for simplicity in admin panel
                    specialOffers = specialOffers.filter(offer => offer.id !== id);
                    saveSpecialOffers();
                    renderSpecialOffersAdmin();
                    clearOfferForm();
                    showAdminMessageModal('成功', '優惠活動已刪除！', 'success');
                }
            }

            function updateSpecialOffer() {
                const idToUpdate = parseInt(editOfferIdInput.value);
                if (isNaN(idToUpdate)) {
                    showAdminMessageModal('更新錯誤', '請選擇要更新的優惠活動。', 'error');
                    return;
                }

                if (!validateOfferForm(false)) {
                    return;
                }

                const offerIndex = specialOffers.findIndex(offer => offer.id === idToUpdate);
                if (offerIndex === -1) {
                    showAdminMessageModal('更新錯誤', '未找到要更新的優惠活動。', 'error');
                    return;
                }

                specialOffers[offerIndex] = {
                    ...specialOffers[offerIndex],
                    name: offerNameInput.value.trim(),
                    description: offerDescriptionInput.value.trim(),
                    originalPrice: parseFloat(offerOriginalPriceInput.value),
                    specialPrice: parseFloat(offerSpecialPriceInput.value),
                    image: offerImageInput.value.trim() || specialOffers[offerIndex].image // Keep existing image if new is empty
                };
                saveSpecialOffers();
                renderSpecialOffersAdmin();
                clearOfferForm();
                showAdminMessageModal('成功', '優惠活動已更新！', 'success');
            }


            // --- Event Listeners ---
            loadCoffeeDataBtn.addEventListener('click', loadCoffeeBeans);
            saveCoffeeDataBtn.addEventListener('click', saveCoffeeBeans);
            addCoffeeBtn.addEventListener('click', addCoffee);
            updateCoffeeBtn.addEventListener('click', updateCoffee);
            clearCoffeeFormBtn.addEventListener('click', clearCoffeeForm);

            loadOfferDataBtn.addEventListener('click', loadSpecialOffers);
            saveOfferDataBtn.addEventListener('click', saveSpecialOffers);
            addOfferBtn.addEventListener('click', addSpecialOffer);
            updateOfferBtn.addEventListener('click', updateSpecialOffer);
            clearOfferFormBtnOffer.addEventListener('click', clearOfferForm); // Use the renamed variable

            // Initial load for admin panel when opened
            loadCoffeeBeans();
            loadSpecialOffers();
        });
    </script>
</body>
</html>
