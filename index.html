<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Bean | 後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #fdfaf5; /* 溫暖米白 */
            --color-surface: #ffffff;
            --color-primary: #b58863; /* 柔和木質棕 */
            --color-secondary: #3f2e2e; /* 深咖啡文字 */
            --color-accent: #6b8e23; /* 橄欖綠 */
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-secondary);
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        h1, h2 {
            font-family: 'Playfair Display', serif;
            color: var(--color-primary);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #a07654;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: var(--color-secondary);
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn-secondary:hover {
            background-color: #d0d0d0;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        input[type="text"], input[type="number"], input[type="url"], input[type="date"], textarea, select {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem;
            width: 100%;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="url"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(181, 136, 99, 0.2);
            outline: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: var(--color-secondary);
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--color-surface);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-close-button {
            color: #888;
            font-size: 24px;
            position: absolute;
            top: 15px;
            right: 18px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: var(--color-secondary);
        }
        .icon-success { color: var(--color-accent); }
        .icon-error { color: #ef4444; }
        .icon-info { color: var(--color-primary); }
        .modal-message-content {
            max-height: 40vh;
            overflow-y: auto;
            padding-right: 15px;
            margin-bottom: 1rem;
            text-align: left;
            padding-left: 5px;
        }
        .stock-indicator {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85em;
        }
        .stock-in-stock {
            background-color: #d1fae5; /* 綠色-100 */
            color: #065f46; /* 綠色-800 */
        }
        .stock-low-stock {
            background-color: #fef3c7; /* 黃色-100 */
            color: #92400e; /* 黃色-800 */
        }
        .stock-out-of-stock {
            background-color: #fee2e2; /* 紅色-100 */
            color: #991b1b; /* 紅色-800 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="bg-primary text-white p-4 shadow-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-serif">Melody Bean | 後台管理</h1>
            <a href="展示.html" class="px-4 py-2 rounded-full bg-white text-primary hover:bg-gray-100 transition-colors">
                <i class="fas fa-home mr-2"></i> 前台首頁
            </a>
        </div>
    </header>

    <main class="flex-grow container">
        <h2 class="text-3xl font-serif text-center mb-6">咖啡豆品項管理</h2>

        <!-- Product Form -->
        <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 border border-gray-200 rounded-lg shadow-sm mb-8">
            <input type="hidden" id="product-id">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">名稱 <span class="text-red-500">*</span></label>
                <input type="text" id="name" required>
            </div>
            <div>
                <label for="country" class="block text-sm font-medium text-gray-700 mb-1">國家 <span class="text-red-500">*</span></label>
                <input type="text" id="country" required>
            </div>
            <div>
                <label for="variety" class="block text-sm font-medium text-gray-700 mb-1">品種</label>
                <input type="text" id="variety">
            </div>
            <div>
                <label for="processing" class="block text-sm font-medium text-gray-700 mb-1">處理法</label>
                <input type="text" id="processing">
            </div>
            <div>
                <label for="altitude" class="block text-sm font-medium text-gray-700 mb-1">海拔</label>
                <input type="text" id="altitude">
            </div>
            <div>
                <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">重量 <span class="text-red-500">*</span></label>
                <input type="text" id="weight" required placeholder="例如: 200g">
            </div>
            <div>
                <label for="roast" class="block text-sm font-medium text-gray-700 mb-1">烘焙度 <span class="text-red-500">*</span></label>
                <input type="text" id="roast" required placeholder="例如: 淺焙, 中深烘焙">
            </div>
            <div>
                <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">期限 <span class="text-red-500">*</span></label>
                <input type="date" id="expiry" required>
            </div>
            <div>
                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">售價 (NT$) <span class="text-red-500">*</span></label>
                <input type="number" id="price" min="0" required>
            </div>
            <div>
                <label for="stock" class="block text-sm font-medium text-gray-700 mb-1">庫存數量 <span class="text-red-500">*</span></label>
                <input type="number" id="stock" min="0" required>
            </div>
            <div class="md:col-span-2">
                <label for="flavor" class="block text-sm font-medium text-gray-700 mb-1">風味描述 <span class="text-red-500">*</span></label>
                <textarea id="flavor" rows="2" required placeholder="例如: 黑巧克力、焦糖、堅果"></textarea>
            </div>
            <div class="md:col-span-2">
                <label for="image" class="block text-sm font-medium text-gray-700 mb-1">圖片網址</label>
                <input type="url" id="image" placeholder="例如: https://example.com/coffee.jpg">
            </div>
            <div>
                <label for="farm_or_station" class="block text-sm font-medium text-gray-700 mb-1">處理場/莊園</label>
                <input type="text" id="farm_or_station">
            </div>
            <div>
                <label for="lifestyle" class="block text-sm font-medium text-gray-700 mb-1">生活提案</label>
                <textarea id="lifestyle" rows="2" placeholder="例如: 早晨提神、搭配甜點"></textarea>
            </div>
            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-5 gap-4">
                <label class="block text-sm font-medium text-gray-700 sm:col-span-5 mb-1">風味雷達圖 (0-100)</label>
                <div>
                    <label for="profile-bitter" class="block text-xs font-medium text-gray-600">苦味</label>
                    <input type="number" id="profile-bitter" min="0" max="100" value="50">
                </div>
                <div>
                    <label for="profile-acidity" class="block text-xs font-medium text-gray-600">酸度</label>
                    <input type="number" id="profile-acidity" min="0" max="100" value="50">
                </div>
                <div>
                    <label for="profile-body" class="block text-xs font-medium text-gray-600">醇厚度</label>
                    <input type="number" id="profile-body" min="0" max="100" value="50">
                </div>
                <div>
                    <label for="profile-floral" class="block text-xs font-medium text-gray-600">花果香</label>
                    <input type="number" id="profile-floral" min="0" max="100" value="50">
                </div>
                <div>
                    <label for="profile-nutty" class="block text-xs font-medium text-gray-600">堅果/巧克力</label>
                    <input type="number" id="profile-nutty" min="0" max="100" value="50">
                </div>
            </div>

            <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                <button type="submit" id="save-product-btn" class="px-6 py-2 rounded-md btn-primary">
                    <i class="fas fa-save mr-2"></i> 新增/更新品項
                </button>
                <button type="button" id="clear-form-btn" class="px-6 py-2 rounded-md btn-secondary">
                    <i class="fas fa-eraser mr-2"></i> 清除表單
                </button>
            </div>
        </form>

        <!-- Product List Table -->
        <h3 class="text-2xl font-serif mb-4">現有咖啡豆品項</h3>
        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>名稱</th>
                        <th>國家</th>
                        <th>品種</th>
                        <th>處理法</th>
                        <th>海拔</th>
                        <th>重量</th>
                        <th>烘焙度</th>
                        <th>期限</th>
                        <th>售價</th>
                        <th>庫存</th>
                        <th>風味</th>
                        <th>圖片</th>
                        <th>處理場/莊園</th>
                        <th>生活提案</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="products-table-body">
                    <!-- Product rows will be loaded here by JavaScript -->
                    <tr><td colspan="15" class="text-center py-4 text-gray-500">載入咖啡豆品項中...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer class="bg-secondary text-white py-4 mt-8">
        <div class="max-w-6xl mx-auto text-center text-gray-300">
            <p>&copy; 2024 Melody Bean. 後台管理.</p>
        </div>
    </footer>

    <!-- Custom Modal for messages and confirmations -->
    <div id="adminMessageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeAdminMessageModal()">&times;</span>
            <div id="modalIcon" class="text-5xl mb-4"></div>
            <h3 id="modalTitle" class="text-2xl font-serif mb-4"></h3>
            <p id="modalMessage" class="text-gray-700 mb-4 modal-message-content"></p>
            <div id="modalButtons" class="flex justify-center space-x-4">
                <button onclick="closeAdminMessageModal()" class="btn-primary px-6 py-2 rounded-full">確認</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Global variables provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app;
        let db;
        let auth;
        let productsCollectionRef;
        let currentEditingProductId = null; // To keep track of the product being edited

        // Initial coffee products to populate if the collection is empty
        const initialCoffeeProducts = [
            {
                name: '衣索比亞 GEISHA 水洗 (百香果)',
                country: '衣索比亞',
                variety: 'GEISHA 水洗',
                processing: '水洗',
                altitude: 'N/A',
                weight: '114克',
                roast: '淺焙',
                expiry: '2025-10-12', // YYYY-MM-DD format for date input
                price: 280,
                flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬、百香果',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=Ethiopia+Geisha',
                stock: 50,
                farm_or_station: 'N/A',
                lifestyle: '清新愉悅的早晨，搭配輕食或獨自品味，感受花果香氣的奔放。',
                profile: [30, 90, 60, 95, 40] // Bitter, Acidity, Body, Floral/Fruit, Nut/Chocolate
            },
            {
                name: '衣索比亞 Heirloom 雙重厭氧水洗',
                country: '衣索比亞',
                variety: 'Heirloom',
                processing: '雙重厭氧水洗',
                altitude: '2000-2100公尺',
                weight: '227克',
                roast: '淺焙',
                expiry: '2025-10-28',
                price: 600,
                flavor: '茉莉、橙花、蜂蜜、水蜜桃',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=Ethiopia+Heirloom',
                stock: 75,
                farm_or_station: 'N/A',
                lifestyle: '午後茶點時光，享受其細膩的甜感和豐富的層次，適合靜心品嚐。',
                profile: [40, 85, 70, 90, 50]
            },
            {
                name: '衣索比亞 GEISHA (227g)',
                country: '衣索比亞',
                variety: 'GEISHA',
                processing: 'N/A',
                altitude: 'N/A',
                weight: '227克',
                roast: '中淺焙',
                expiry: '2025-11-01',
                price: 540,
                flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=Ethiopia+Geisha+227g',
                stock: 60,
                farm_or_station: 'N/A',
                lifestyle: '適合在需要靈感或專注的時刻品飲，其複雜的香氣能激發思緒。',
                profile: [35, 90, 65, 90, 45]
            },
            {
                name: '衣索比亞 GEISHA 水洗 (227g, 高海拔)',
                country: '衣索比亞',
                variety: 'GEISHA 水洗',
                processing: '水洗',
                altitude: '2280公尺',
                weight: '227克',
                roast: '中淺焙',
                expiry: '2025-11-01',
                price: 540,
                flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=Ethiopia+Geisha+HighAlt',
                stock: 45,
                farm_or_station: 'N/A',
                lifestyle: '高海拔咖啡的獨特風味，適合在悠閒的週末午後，享受其純淨與層次。',
                profile: [30, 95, 60, 95, 40]
            },
            {
                name: '衣索比亞 精選淺焙 (227g)',
                country: '衣索比亞',
                variety: '精選',
                processing: 'N/A',
                altitude: 'N/A',
                weight: '227克',
                roast: '淺焙',
                expiry: '2025-11-01',
                price: 540,
                flavor: '接骨木花、茉莉花橙花、白玫瑰、百合花蘋果、野莓果醬、檸檬',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=Ethiopia+Selected',
                stock: 70,
                farm_or_station: 'N/A',
                lifestyle: '每日早晨的活力泉源，讓您在忙碌中也能品味到非洲的陽光與花香。',
                profile: [35, 88, 62, 92, 42]
            },
            {
                name: '哥斯大黎加 Geisha 白蜜 (114g)',
                country: '哥斯大黎加',
                variety: 'Geisha（藝妓）',
                processing: '白蜜',
                altitude: '1950公尺',
                weight: '114克',
                roast: '淺',
                expiry: '2025-08-15',
                price: 800,
                flavor: '百合花、野薑花、檸檬草、柑橘、紅色莓果、蜂蜜',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=CostaRica+Geisha+114g',
                stock: 30,
                farm_or_station: '聖伊西多羅',
                lifestyle: '獨特的藝妓風味，適合在特別的節日或與摯友分享，體驗其優雅與複雜。',
                profile: [40, 92, 68, 88, 55]
            },
            {
                name: '哥斯大黎加 Geisha 白蜜 (227g)',
                country: '哥斯大黎加',
                variety: 'Geisha（藝妓）',
                processing: '白蜜',
                altitude: '1950公尺',
                weight: '227克',
                roast: '淺',
                expiry: '2025-08-15',
                price: 1800,
                flavor: '百合花、野薑花、檸檬草、柑橘、紅色莓果、蜂蜜',
                image: 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=CostaRica+Geisha+227g',
                stock: 20,
                farm_or_station: '聖伊西多羅',
                lifestyle: '珍稀的藝妓咖啡，適合深度咖啡愛好者，在寧靜的夜晚細細品味。',
                profile: [40, 92, 68, 88, 55]
            }
        ];

        // Custom Modal Functions
        function showAdminMessageModal(title, message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('adminMessageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');
            const modalButtons = document.getElementById('modalButtons');

            // Reset classes and content
            modalTitle.className = 'text-2xl font-serif mb-4';
            modalIcon.className = 'text-5xl mb-4';
            modalButtons.innerHTML = ''; // Clear previous buttons

            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML to allow for basic HTML tags if needed

            // Set icon and title color based on type
            switch (type) {
                case 'success':
                    modalIcon.innerHTML = '<i class="fas fa-check-circle icon-success"></i>';
                    break;
                case 'error':
                    modalIcon.innerHTML = '<i class="fas fa-times-circle icon-error"></i>';
                    break;
                case 'info':
                default:
                    modalIcon.innerHTML = '<i class="fas fa-info-circle icon-info"></i>';
                    break;
            }

            if (onConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-danger px-6 py-2 rounded-full';
                confirmBtn.textContent = '確認刪除';
                confirmBtn.onclick = () => {
                    onConfirm();
                    closeAdminMessageModal();
                };
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn-secondary px-6 py-2 rounded-full';
                cancelBtn.textContent = '取消';
                cancelBtn.onclick = closeAdminMessageModal;
                modalButtons.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'btn-primary px-6 py-2 rounded-full';
                okBtn.textContent = '確認';
                okBtn.onclick = closeAdminMessageModal;
                modalButtons.appendChild(okBtn);
            }

            modal.classList.add('active'); // Show modal
        }

        function closeAdminMessageModal() {
            document.getElementById('adminMessageModal').classList.remove('active');
        }

        // Firebase Initialization
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config not found. Admin panel will not function.");
                showAdminMessageModal('設定錯誤', 'Firebase 設定檔遺失。請檢查環境變數。', 'error');
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            productsCollectionRef = collection(db, `artifacts/${appId}/public/data/coffeeProducts`);

            try {
                // Sign in anonymously for admin panel. In a real app, you'd use proper authentication.
                const userCredential = await signInAnonymously(auth);
                console.log("[Firebase] Admin signed in anonymously:", userCredential.user.uid);
                
                // Check if the collection is empty and populate with initial data
                const existingDocs = await getDocs(productsCollectionRef);
                if (existingDocs.empty) {
                    showAdminMessageModal('初始化資料', '首次載入，正在初始化咖啡豆資料...', 'info');
                    for (const product of initialCoffeeProducts) {
                        await addDoc(productsCollectionRef, product);
                    }
                    showAdminMessageModal('初始化完成', '咖啡豆資料已成功初始化！', 'success');
                }

                listenToProducts(); // Start listening for real-time updates
            } catch (error) {
                console.error("[Firebase] Admin authentication or initialization error:", error);
                showAdminMessageModal('登入錯誤', `無法登入 Firebase：${error.message}`, 'error');
            }
        }

        // Listen for real-time updates to the coffeeProducts collection
        function listenToProducts() {
            const q = query(productsCollectionRef, orderBy('name')); // Order by name for consistent display

            onSnapshot(q, (snapshot) => {
                const products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProductsTable(products);
                console.log("[Firebase] Products updated:", products.length);
            }, (error) => {
                console.error("[Firebase] Error listening to products:", error);
                showAdminMessageModal('資料載入錯誤', `無法載入咖啡豆資料：${error.message}`, 'error');
            });
        }

        // Render products in the table
        function renderProductsTable(products) {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-gray-500">目前沒有咖啡豆品項。</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = tableBody.insertRow();
                row.dataset.id = product.id; // Store Firestore document ID on the row

                // Helper to get stock status class
                const getStockStatusClass = (stock) => {
                    if (stock > 50) return 'stock-in-stock';
                    if (stock > 0) return 'stock-low-stock';
                    return 'stock-out-of-stock';
                };
                const getStockStatusText = (stock) => {
                    if (stock > 50) return '庫存充足';
                    if (stock > 0) return '庫存緊張';
                    return '已售罄';
                };

                row.innerHTML = `
                    <td class="text-sm">${product.name || 'N/A'}</td>
                    <td class="text-sm">${product.country || 'N/A'}</td>
                    <td class="text-sm">${product.variety || 'N/A'}</td>
                    <td class="text-sm">${product.processing || 'N/A'}</td>
                    <td class="text-sm">${product.altitude || 'N/A'}</td>
                    <td class="text-sm">${product.weight || 'N/A'}</td>
                    <td class="text-sm">${product.roast || 'N/A'}</td>
                    <td class="text-sm">${product.expiry || 'N/A'}</td>
                    <td class="text-sm">NT$${product.price !== undefined ? product.price : 'N/A'}</td>
                    <td class="text-sm">${product.stock !== undefined ? product.stock : 'N/A'} <span class="stock-indicator ${getStockStatusClass(product.stock)}">${getStockStatusText(product.stock)}</span></td>
                    <td class="text-sm max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${product.flavor || 'N/A'}">${product.flavor || 'N/A'}</td>
                    <td class="text-sm">
                        ${product.image ? `<img src="${product.image}" alt="圖片" class="w-16 h-auto rounded-md object-cover" onerror="this.onerror=null;this.src='https://placehold.co/64x64/e0e0e0/3f2e2e?text=No+Img';">` : '無圖片'}
                    </td>
                    <td class="text-sm">${product.farm_or_station || 'N/A'}</td>
                    <td class="text-sm max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${product.lifestyle || 'N/A'}">${product.lifestyle || 'N/A'}</td>
                    <td class="text-sm">
                        <button type="button" class="text-blue-600 hover:text-blue-800 mr-2" onclick="editProduct('${product.id}')">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                        <button type="button" class="text-red-600 hover:text-red-800" onclick="confirmDeleteProduct('${product.id}', '${product.name}')">
                            <i class="fas fa-trash-alt"></i> 刪除
                        </button>
                    </td>
                `;
            });
        }

        // Populate form for editing
        window.editProduct = async function(id) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/coffeeProducts`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const product = docSnap.data();
                    currentEditingProductId = id; // Set current editing ID

                    document.getElementById('product-id').value = id;
                    document.getElementById('name').value = product.name || '';
                    document.getElementById('country').value = product.country || '';
                    document.getElementById('variety').value = product.variety || '';
                    document.getElementById('processing').value = product.processing || '';
                    document.getElementById('altitude').value = product.altitude || '';
                    document.getElementById('weight').value = product.weight || '';
                    document.getElementById('roast').value = product.roast || '';
                    document.getElementById('expiry').value = product.expiry || '';
                    document.getElementById('price').value = product.price !== undefined ? product.price : '';
                    document.getElementById('stock').value = product.stock !== undefined ? product.stock : '';
                    document.getElementById('flavor').value = product.flavor || '';
                    document.getElementById('image').value = product.image || '';
                    document.getElementById('farm_or_station').value = product.farm_or_station || '';
                    document.getElementById('lifestyle').value = product.lifestyle || '';

                    // Populate radar chart profile
                    const profile = product.profile || [50, 50, 50, 50, 50];
                    document.getElementById('profile-bitter').value = profile[0];
                    document.getElementById('profile-acidity').value = profile[1];
                    document.getElementById('profile-body').value = profile[2];
                    document.getElementById('profile-floral').value = profile[3];
                    document.getElementById('profile-nutty').value = profile[4];

                    document.getElementById('save-product-btn').textContent = '更新品項';
                    document.getElementById('save-product-btn').classList.remove('btn-primary');
                    document.getElementById('save-product-btn').classList.add('bg-blue-600', 'hover:bg-blue-700'); // Use a different color for update
                    showAdminMessageModal('編輯品項', `您正在編輯 ${product.name}。`, 'info');
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top to see the form
                } else {
                    showAdminMessageModal('錯誤', '找不到該品項。', 'error');
                }
            } catch (error) {
                console.error("Error editing product:", error);
                showAdminMessageModal('編輯錯誤', `載入編輯資料失敗：${error.message}`, 'error');
            }
        };

        // Clear form
        function clearForm() {
            document.getElementById('product-id').value = '';
            document.getElementById('name').value = '';
            document.getElementById('country').value = '';
            document.getElementById('variety').value = '';
            document.getElementById('processing').value = '';
            document.getElementById('altitude').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('roast').value = '';
            document.getElementById('expiry').value = '';
            document.getElementById('price').value = '';
            document.getElementById('stock').value = '';
            document.getElementById('flavor').value = '';
            document.getElementById('image').value = '';
            document.getElementById('farm_or_station').value = '';
            document.getElementById('lifestyle').value = '';

            document.getElementById('profile-bitter').value = 50;
            document.getElementById('profile-acidity').value = 50;
            document.getElementById('profile-body').value = 50;
            document.getElementById('profile-floral').value = 50;
            document.getElementById('profile-nutty').value = 50;

            currentEditingProductId = null; // Reset editing ID
            document.getElementById('save-product-btn').textContent = '新增/更新品項';
            document.getElementById('save-product-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('save-product-btn').classList.add('btn-primary');
            showAdminMessageModal('表單已清除', '您可以開始新增或選擇編輯品項。', 'info');
        }

        // Confirm delete
        window.confirmDeleteProduct = function(id, name) {
            showAdminMessageModal(
                '確認刪除',
                `您確定要刪除品項：<strong>${name}</strong> 嗎？此操作無法復原。`,
                'error',
                () => deleteProduct(id)
            );
        };

        // Delete product
        async function deleteProduct(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/coffeeProducts`, id));
                showAdminMessageModal('刪除成功', '品項已成功刪除！', 'success');
                clearForm(); // Clear form after deletion
            } catch (error) {
                console.error("Error deleting product:", error);
                showAdminMessageModal('刪除失敗', `刪除品項失敗：${error.message}`, 'error');
            }
        }

        // Handle form submission (Add/Update)
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                name: document.getElementById('name').value,
                country: document.getElementById('country').value,
                variety: document.getElementById('variety').value,
                processing: document.getElementById('processing').value,
                altitude: document.getElementById('altitude').value,
                weight: document.getElementById('weight').value,
                roast: document.getElementById('roast').value,
                expiry: document.getElementById('expiry').value,
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
                flavor: document.getElementById('flavor').value,
                image: document.getElementById('image').value,
                farm_or_station: document.getElementById('farm_or_station').value,
                lifestyle: document.getElementById('lifestyle').value,
                profile: [
                    parseInt(document.getElementById('profile-bitter').value),
                    parseInt(document.getElementById('profile-acidity').value),
                    parseInt(document.getElementById('profile-body').value),
                    parseInt(document.getElementById('profile-floral').value),
                    parseInt(document.getElementById('profile-nutty').value)
                ]
            };

            // Basic validation
            if (!productData.name || !productData.country || !productData.weight || !productData.roast || !productData.expiry || isNaN(productData.price) || isNaN(productData.stock) || !productData.flavor) {
                showAdminMessageModal('輸入錯誤', '請填寫所有標記 <span class="text-red-500">*</span> 的必填欄位，並確保價格和庫存為有效數字。', 'error');
                return;
            }

            try {
                if (currentEditingProductId) {
                    // Update existing product
                    const docRef = doc(db, `artifacts/${appId}/public/data/coffeeProducts`, currentEditingProductId);
                    await updateDoc(docRef, productData);
                    showAdminMessageModal('更新成功', `${productData.name} 已成功更新！`, 'success');
                } else {
                    // Add new product
                    await addDoc(productsCollectionRef, productData);
                    showAdminMessageModal('新增成功', `${productData.name} 已成功新增！`, 'success');
                }
                clearForm(); // Clear form after successful operation
            } catch (error) {
                console.error("Error saving product:", error);
                showAdminMessageModal('操作失敗', `儲存品項失敗：${error.message}`, 'error');
            }
        });

        // Event listener for Clear Form button
        document.getElementById('clear-form-btn').addEventListener('click', clearForm);

        // Initialize Firebase on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
