<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Bean | å¾Œç«¯ç®¡ç†ä»‹é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #b58863;
        }
        input[type="text"], input[type="number"], input[type=\"date\"], textarea, select {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box; /* Ensures padding doesn't increase total width */
        }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-blue { background-color: #4299e1; }
        .btn-blue:hover { background-color: #3182ce; }
        .btn-green { background-color: #48bb78; }
        .btn-green:hover { background-color: #38a169; }
        .btn-purple { background-color: #805ad5; }
        .btn-purple:hover { background-color: #6b46c1; }
        .btn-yellow { background-color: #ecc94b; }
        .btn-yellow:hover { background-color: #d69e2e; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .card {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background-color: #fdfdfd;
        }
        .item-list li {
            background-color: #fdfaf5;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f0f0f0;
        }
        /* Custom styles for admin message modal */
        .admin-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .admin-modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        .admin-modal-close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .admin-modal-close-button:hover,
        .admin-modal-close-button:focus {
            color: black;
        }
        .admin-modal-success { color: #48bb78; } /* Green */
        .admin-modal-error { color: #ef4444; } /* Red */
    </style>
</head>
<body>
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold mb-8">Melody Bean å¾Œç«¯ç®¡ç†ä»‹é¢</h1>

        <section class="mb-12">
            <h2 class="text-3xl font-semibold mb-6">å’–å•¡è±†ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-4">ç¾æœ‰å’–å•¡è±†åˆ—è¡¨</h3>
                <ul id="admin-coffee-list" class="item-list list-none pl-0 space-y-2 mb-4">
                    <!-- Coffee beans will be listed here -->
                </ul>
                <div class="flex gap-2">
                    <!-- è¼‰å…¥å’Œå„²å­˜æŒ‰éˆ•ç¾åœ¨å°‡èˆ‡ Firestore äº’å‹• -->
                    <button id="load-coffee-data" class="btn-blue">å¾è³‡æ–™åº«è¼‰å…¥å’–å•¡è±†</button>
                    <button id="save-coffee-data" class="btn-green">å„²å­˜å’–å•¡è±†åˆ°è³‡æ–™åº«</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">æ–°å¢ / ç·¨è¼¯å’–å•¡è±†</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="hidden" id="edit-coffee-id">
                    <input type="text" id="coffee-name" placeholder="åç¨± (å¿…å¡«)" class="p-2 border rounded-md" required>
                    <input type="text" id="coffee-country" placeholder="åœ‹å®¶" class="p-2 border rounded-md">
                    <input type="text" id="coffee-variety" placeholder="å“ç¨®" class="p-2 border rounded-md">
                    <input type="text" id="coffee-flavor" placeholder="é¢¨å‘³æè¿°" class="p-2 border rounded-md">
                    <select id="coffee-roast" class="p-2 border rounded-md">
                        <option value="" disabled selected>çƒ˜ç„™åº¦</option>
                        <option value="æ·ºç„™">æ·ºç„™</option>
                        <option value="ä¸­æ·ºç„™">ä¸­æ·ºç„™</option>
                        <option value="ä¸­ç„™">ä¸­ç„™</option>
                        <option value="ä¸­æ·±ç„™">ä¸­æ·±ç„™</option>
                        <option value="æ·±ç„™">æ·±ç„™</option>
                    </select>
                    <input type="text" id="coffee-weight" placeholder="é‡é‡ (ä¾‹å¦‚: 114g, 227g)" class="p-2 border rounded-md">
                    <input type="number" id="coffee-price" placeholder="å”®åƒ¹ (å¿…å¡«)" class="p-2 border rounded-md" required>
                    <input type="date" id="coffee-expiry" placeholder="æœŸé™ (YYYY-MM-DD)" class="p-2 border rounded-md">
                    <input type="number" id="coffee-stock" placeholder="åº«å­˜ (æ•¸é‡) (å¿…å¡«)" min="0" class="p-2 border rounded-md" required> <!-- NEW STOCK FIELD -->
                    <select id="coffee-category" class="p-2 border rounded-md">
                        <option value="" disabled selected>åˆ†é¡</option>
                        <option value="light">æ·ºç„™é¡</option>
                        <option value="medium">ä¸­ç„™é¡</option>
                        <option value="dark">æ·±ç„™é¡</option>
                    </select>
                    <input type="text" id="coffee-image" placeholder="åœ–ç‰‡URL (ä¾‹å¦‚: ./image/image_1.png æˆ– placehold.co)" class="p-2 border rounded-md col-span-2">
                    <textarea id="coffee-lifestyle" placeholder="ç”Ÿæ´»ææ¡ˆ (ä¾‹å¦‚: é©åˆåœ¨éœè¬çš„åˆå¾Œç´°ç´°å“å‘³)" class="p-2 border rounded-md col-span-2"></textarea>
                    
                    <!-- Flavor Profile Inputs (optional, could be more complex UI) -->
                    <h4 class="col-span-2 text-md font-semibold mt-2">é¢¨å‘³åœ–è­œè©•åˆ† (1-5)</h4>
                    <input type="number" id="fp-acidity" placeholder="é…¸åº¦" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-body" placeholder="é†‡åšåº¦" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-sweetness" placeholder="ç”œåº¦" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-aroma" placeholder="é¦™æ°£" min="0" max="5" class="p-2 border rounded-md">
                    <input type="number" id="fp-finish" placeholder="é¤˜éŸ»" min="0" max="5" class="p-2 border rounded-md">
                </div>
                <div class="flex gap-2">
                    <button id="add-coffee" class="btn-purple">æ–°å¢å’–å•¡è±†</button>
                    <button id="update-coffee" class="btn-yellow">æ›´æ–°é¸å®šå’–å•¡è±†</button>
                    <button id="clear-coffee-form" class="btn-blue">æ¸…é™¤è¡¨å–®</button>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-3xl font-semibold mb-6">å„ªæƒ æ´»å‹•ç®¡ç†</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-4">ç¾æœ‰å„ªæƒ æ´»å‹•åˆ—è¡¨</h3>
                <ul id="admin-offer-list" class="item-list list-none pl-0 space-y-2 mb-4">
                    <!-- Offers will be listed here -->
                </ul>
                <div class="flex gap-2">
                    <!-- è¼‰å…¥å’Œå„²å­˜æŒ‰éˆ•ç¾åœ¨å°‡èˆ‡ Firestore äº’å‹• -->
                    <button id="load-offer-data" class="btn-blue">å¾è³‡æ–™åº«è¼‰å…¥å„ªæƒ </button>
                    <button id="save-offer-data" class="btn-green">å„²å­˜å„ªæƒ åˆ°è³‡æ–™åº«</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">æ–°å¢ / ç·¨è¼¯å„ªæƒ </h3>
                <input type="hidden" id="edit-offer-id">
                <input type="text" id="offer-name" placeholder="åç¨± (å¿…å¡«)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="text" id="offer-description" placeholder="æè¿° (å¿…å¡«)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="number" id="offer-original-price" placeholder="åŸåƒ¹ (å¿…å¡«)" class="p-2 border rounded-md w-full mb-2" required>
                <input type="number" id="offer-special-price" placeholder="ç‰¹åƒ¹ (å¿…å¡«)" class="p-2 border rounded-md w-full mb-4" required>
                <input type="text" id="offer-image" placeholder="åœ–ç‰‡URL (ä¾‹å¦‚: placehold.co)" class="p-2 border rounded-md w-full mb-4">
                <div class="flex gap-2">
                    <button id="add-offer" class="btn-purple">æ–°å¢å„ªæƒ </button>
                    <button id="update-offer" class="btn-yellow">æ›´æ–°é¸å®šå„ªæƒ </button>
                    <button id="clear-offer-form" class="btn-blue">æ¸…é™¤è¡¨å–®</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Admin Message Modal -->
    <div id="adminMessageModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-modal-close-button" onclick="closeAdminMessageModal()">&times;</span>
            <h3 id="adminModalTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="adminModalMessage" class="text-gray-700 mb-6"></p>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="closeAdminMessageModal()">äº†è§£</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase services - MUST be at the top level of a module script
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, updateDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Start IIFE for encapsulation of the main logic
        (async function() {
            // Firebase Initialization
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            let app;
            let db;
            let auth;
            let userId = 'anonymous'; // Default to anonymous

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Set userId after authentication
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`Firestore Authenticated. User ID: ${userId}`);

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showAdminMessageModal('éŒ¯èª¤', `Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                return; // Stop execution if Firebase fails to initialize
            }

            // ğŸ“¦ dataManager.js - çµ±ä¸€å„ªæƒ è³‡æ–™ç®¡ç†æ¨¡çµ„
            // Note: This dataManager logic will now primarily act as a schema definition and default provider
            // The actual loading/saving will be handled by Firestore
            const defaultOfferTemplate = {
                id: '', // Will use Firestore doc.id
                name: '',
                description: '',
                originalPrice: 0,
                specialPrice: 0,
                image: ''
            };

            // æ–°å¢é è¨­å„ªæƒ æ´»å‹•è³‡æ–™ï¼Œç¢ºä¿å‰å¾Œå°é è¨­å€¼ä¸€è‡´
            const DEFAULT_SPECIAL_OFFERS = [
                { id: 'default-offer-1', name: 'é è¨­å„ªæƒ ï¼šç³»çµ±åˆå§‹é«”é©—åŒ…', description: 'é€™æ˜¯ç³»çµ±é è¨­çš„å„ªæƒ ï¼Œå¦‚æœè³‡æ–™åº«ä¸­æ²’æœ‰æ•¸æ“šï¼Œå°‡æœƒé¡¯ç¤ºæ­¤å„ªæƒ ã€‚', originalPrice: 500, specialPrice: 400, image: 'https://placehold.co/400x200/b58863/FFFFFF?text=Default+Offer' }
            ];

            /**
             * ğŸ§  mergeWithDefaultSchema
             * å°‡è¼¸å…¥çš„æ¯ç­†è³‡æ–™è£œé½Šç‚ºèˆ‡é è¨­æ¬„ä½ä¸€è‡´çš„æ ¼å¼
             * @param {Array<Object>} dataArray - åŸå§‹å„ªæƒ è³‡æ–™
             * @param {Object} defaultTemplate - æ¬„ä½æ¨¡æ¿
             * @returns {Array<Object>}
             */
            function mergeWithDefaultSchema(dataArray, defaultTemplate) {
                if (!Array.isArray(dataArray)) return [];
                return dataArray.map(item => ({
                    ...defaultTemplate,
                    ...item
                }));
            }

            // Expose OfferDataManager globally if needed for other scripts (though now primarily internal)
            window.OfferDataManager = {
                mergeWithDefaultSchema,
                defaultOfferTemplate,
                DEFAULT_SPECIAL_OFFERS 
            };
            // ğŸ“¦ dataManager.js END

            // --- Firestore Collection References ---
            const coffeeBeansCollection = collection(db, `artifacts/${appId}/users/${userId}/coffeeBeans`);
            const specialOffersCollection = collection(db, `artifacts/${appId}/users/${userId}/specialOffers`);

            // --- Default Data (Hardcoded for initial setup if Firestore is empty) ---
            const defaultCoffeeBeans = [
                { name: 'GEISHA æ°´æ´—ï¼ˆ114gï¼‰', country: 'è¡£ç´¢æ¯”äº', variety: 'GEISHA æ°´æ´—', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬ã€ç™¾é¦™æœ', roast: 'æ·ºç„™', weight: '114g', expiryDate: '2025-10-12', price: 280, stock: 10, category: 'light', image: './image/image_1.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'é€™æ¬¾å’–å•¡å……æ»¿è¤‡é›œçš„é¦™æ°£èˆ‡æ˜äº®çš„é¢¨å‘³ï¼Œé©åˆåœ¨éœè¬çš„åˆå¾Œç´°ç´°å“å‘³ï¼Œæˆ–æ­é…è¼•ç›ˆçš„ç”œé»ã€‚' },
                { name: 'Heirloom é›™é‡å­æ°§ï¼ˆ227gï¼‰- æ‰¹æ¬¡A', country: 'è¡£ç´¢æ¯”äº', variety: 'Heirloom', flavor: 'èŒ‰è‰ã€æ©™èŠ±ã€èœ‚èœœã€æ°´èœœæ¡ƒ', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-10-28', price: 600, stock: 5, category: 'light', image: './image/image_2.png', flavorProfile: { acidity: 4, body: 3, sweetness: 5, aroma: 5, finish: 4 }, lifestyle: 'ç”œç¾è€Œè±å¯Œçš„å£æ„Ÿï¼Œæ˜¯é–‹å•Ÿç¾å¥½ä¸€å¤©çš„ç†æƒ³é¸æ“‡ï¼Œèˆ‡æ—©é¤ç³•é»æ­é…å°¤ä½³ã€‚' },
                { name: 'Heirloom é›™é‡å­æ°§ï¼ˆ227gï¼‰- æ‰¹æ¬¡B', country: 'è¡£ç´¢æ¯”äº', variety: 'Heirloom', flavor: 'èŒ‰è‰ã€æ©™èŠ±ã€èœ‚èœœã€æ°´èœœæ¡ƒ', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-10-31', price: 600, stock: 8, category: 'light', image: './image/image_3.png', flavorProfile: { acidity: 4, body: 3, sweetness: 5, aroma: 5, finish: 4 }, lifestyle: 'ç›¸åŒçš„é¢¨å‘³ï¼Œä¸åŒçš„æ¡æ”¶æ‰¹æ¬¡ï¼Œç¢ºä¿æ¯ä¸€æ¯éƒ½æœ‰å§‹çµ‚å¦‚ä¸€çš„ç”œèœœèˆ‡èŠ¬èŠ³ã€‚' },
                { name: 'GEISHAï¼ˆ227gï¼‰ä¸­æ·ºç„™', country: 'è¡£ç´¢æ¯”äº', variety: 'GEISHA', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬', roast: 'ä¸­æ·ºç„™', weight: '227g', expiryDate: '2025-11-01', price: 540, stock: 12, category: 'medium', image: './image/image_4.png', flavorProfile: { acidity: 3, body: 3, sweetness: 3, aroma: 4, finish: 3 }, lifestyle: 'å¹³è¡¡çš„é¢¨å‘³èˆ‡è¼ƒä½çš„é…¸åº¦ï¼Œé©åˆæ—¥å¸¸é£²ç”¨ï¼Œç„¡è«–æ˜¯æ­é…é–±è®€æˆ–å·¥ä½œï¼Œéƒ½èƒ½å¸¶ä¾†æ„‰æ‚…æ„Ÿå—ã€‚' },
                { name: 'GEISHA æ°´æ´—ï¼ˆ227gï¼‰2280m', country: 'è¡£ç´¢æ¯”äº', variety: 'GEISHA æ°´æ´—', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬', roast: 'ä¸­æ·ºç„™', weight: '227g', expiryDate: '2025-11-05', price: 580, stock: 0, category: 'light', image: './image/image_5.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'ä¾†è‡ªé«˜æµ·æ‹”çš„ç¨ç‰¹é¢¨å‘³ï¼Œå»ºè­°åœ¨éœ€è¦ææŒ¯ç²¾ç¥çš„æ—©æ™¨å“åšï¼Œæ„Ÿå—å…¶æ¸…æ™°æ˜äº®çš„å±¤æ¬¡ã€‚' },
                { name: 'è¡£ç´¢æ¯”äº æ·ºç„™ï¼ˆ227gï¼‰', country: 'è¡£ç´¢æ¯”äº', variety: '', flavor: 'æ¥éª¨æœ¨èŠ±ã€èŒ‰è‰èŠ±æ©™èŠ±ã€ç™½ç«ç‘°ã€ç™¾åˆèŠ±è˜‹æœã€é‡è“æœé†¬ã€æª¸æª¬', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-11-01', price: 540, stock: 7, category: 'light', image: './image/image_6.png', flavorProfile: { acidity: 4, body: 2, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'è¼•ç›ˆçš„èŠ±æœèª¿æ€§ï¼Œæ˜¯ä¸‹åˆèŒ¶æ™‚å…‰çš„å®Œç¾ä¼´ä¾¶ï¼Œèƒ½ç‚ºæ‚¨çš„ä¼‘æ†©æ™‚åˆ»å¢æ·»ä¸€æŠ¹äº®è‰²ã€‚' },
                { name: 'å“¥æ–¯å¤§é»åŠ  Geisha ç™½èœœï¼ˆ114gï¼‰', country: 'å“¥æ–¯å¤§é»åŠ ', variety: 'Geishaï¼ˆè—å¦“ï¼‰', flavor: 'ç™¾åˆèŠ±ã€é‡è–‘èŠ±ã€æª¸æª¬è‰ã€æŸ‘æ©˜ã€ç´…è‰²è“æœã€èœ‚èœœ', roast: 'æ·ºç„™', weight: '114g', expiryDate: '2025-08-15', price: 800, stock: 3, category: 'light', image: './image/image_7.png', flavorProfile: { acidity: 5, body: 3, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'æ­¤æ¬¾è—å¦“å’–å•¡é¢¨å‘³ç²¾ç·»å„ªé›…ï¼Œé©åˆåœ¨é‡è¦æ™‚åˆ»æˆ–èˆ‡å¥½å‹åˆ†äº«ï¼Œæ­é…ç°¡ç´„çš„ç”œé»ä»¥çªé¡¯å…¶è±å¯Œå±¤æ¬¡ã€‚' },
                { name: 'å“¥æ–¯å¤§é»åŠ  æ·ºç„™ï¼ˆ227gï¼‰', country: 'å“¥æ–¯å¤§é»åŠ ', variety: '', flavor: 'ç™¾åˆèŠ±ã€é‡è–‘èŠ±ã€æª¸æª¬è‰ã€æŸ‘æ©˜ã€ç´…è‰²è“æœã€èœ‚èœœ', roast: 'æ·ºç„™', weight: '227g', expiryDate: '2025-08-15', price: 1800, stock: 1, category: 'light', image: './image/image_8.png', flavorProfile: { acidity: 5, body: 3, sweetness: 4, aroma: 5, finish: 4 }, lifestyle: 'å¤§å®¹é‡åŒ…è£è®“æ‚¨èƒ½æ›´é•·æ™‚é–“åœ°äº«å—è—å¦“å’–å•¡çš„è¿·äººé­…åŠ›ï¼Œæ¯æ—¥å“é£²æˆ–ä½œç‚ºçè²´è´ˆç¦®çš†å®œã€‚' }
            ];

            // --- Data Variables (will be populated from Firestore) ---
            let coffeeBeans = [];
            let specialOffers = [];

            // --- DOM Elements ---
            const adminCoffeeList = document.getElementById('admin-coffee-list');
            const loadCoffeeBtn = document.getElementById('load-coffee-data');
            const saveCoffeeBtn = document.getElementById('save-coffee-data'); // This button will now trigger a full data re-sync
            const addCoffeeBtn = document.getElementById('add-coffee');
            const updateCoffeeBtn = document.getElementById('update-coffee');
            const clearCoffeeFormBtn = document.getElementById('clear-coffee-form');

            const editCoffeeIdInput = document.getElementById('edit-coffee-id');
            const coffeeNameInput = document.getElementById('coffee-name');
            const coffeeCountryInput = document.getElementById('coffee-country');
            const coffeeVarietyInput = document.getElementById('coffee-variety');
            const coffeeFlavorInput = document.getElementById('coffee-flavor');
            const coffeeRoastInput = document.getElementById('coffee-roast');
            const coffeeWeightInput = document.getElementById('coffee-weight');
            const coffeePriceInput = document.getElementById('coffee-price');
            const coffeeExpiryInput = document.getElementById('coffee-expiry');
            const coffeeStockInput = document.getElementById('coffee-stock');
            const coffeeCategoryInput = document.getElementById('coffee-category');
            const coffeeImageInput = document.getElementById('coffee-image');
            const coffeeLifestyleInput = document.getElementById('coffee-lifestyle');

            const fpAcidityInput = document.getElementById('fp-acidity');
            const fpBodyInput = document.getElementById('fp-body');
            const fpSweetnessInput = document.getElementById('fp-sweetness');
            const fpAromaInput = document.getElementById('fp-aroma');
            const fpFinishInput = document.getElementById('fp-finish');

            const adminOfferList = document.getElementById('admin-offer-list');
            const loadOfferBtn = document.getElementById('load-offer-data');
            const saveOfferBtn = document.getElementById('save-offer-data'); // This button will now trigger a full data re-sync
            const addOfferBtn = document.getElementById('add-offer');
            const updateOfferBtn = document.getElementById('update-offer');
            const clearOfferFormBtn = document.getElementById('clear-offer-form');

            const editOfferIdInput = document.getElementById('edit-offer-id');
            const offerNameInput = document.getElementById('offer-name');
            const offerDescriptionInput = document.getElementById('offer-description');
            const offerOriginalPriceInput = document.getElementById('offer-original-price');
            const offerSpecialPriceInput = document.getElementById('offer-special-price');
            const offerImageInput = document.getElementById('offer-image');

            // --- Admin Message Modal Elements ---
            const adminMessageModal = document.getElementById('adminMessageModal');
            const adminModalTitle = document.getElementById('adminModalTitle');
            const adminModalMessage = document.getElementById('adminModalMessage');

            /**
             * Shows the custom admin message modal.
             * @param {string} title - The title of the message.
             * @param {string} message - The message content.
             * @param {string} type - 'success' or 'error' to change title color.
             * @param {function} [onConfirm] - Optional callback function for confirm type modals.
             * @param {boolean} [isConfirm=false] - Whether this modal is a confirmation dialog.
             */
            function showAdminMessageModal(title, message, type = 'info', onConfirm = null, isConfirm = false) {
                adminModalTitle.textContent = title;
                adminModalMessage.textContent = message;
                adminModalTitle.classList.remove('admin-modal-success', 'admin-modal-error');
                
                const confirmButton = adminMessageModal.querySelector('button');
                const originalButtonText = "äº†è§£"; // Default button text
                confirmButton.onclick = closeAdminMessageModal; // Default close action

                if (type === 'success') {
                    adminModalTitle.classList.add('admin-modal-success');
                } else if (type === 'error') {
                    adminModalTitle.classList.add('admin-modal-error');
                }

                if (isConfirm && onConfirm) {
                    confirmButton.textContent = "ç¢ºèª";
                    confirmButton.onclick = () => {
                        onConfirm();
                        closeAdminMessageModal();
                    };
                    // For simplicity, keeping it as one button that triggers action then closes.
                } else {
                    confirmButton.textContent = originalButtonText;
                }
                adminMessageModal.style.display = 'flex';
            }

            /**
             * Closes the custom admin message modal.
             */
            function closeAdminMessageModal() {
                adminMessageModal.style.display = 'none';
            }

            // --- Coffee Bean Functions (Firestore) ---
            function renderCoffeeBeansAdmin() {
                adminCoffeeList.innerHTML = '';
                if (coffeeBeans.length === 0) {
                    adminCoffeeList.innerHTML = '<li>ç›®å‰æ²’æœ‰å’–å•¡è±†æ•¸æ“šã€‚</li>';
                    return;
                }
                coffeeBeans.forEach(bean => {
                    const listItem = document.createElement('li');
                    listItem.dataset.id = bean.id; // Use Firestore doc.id
                    listItem.innerHTML = `
                        <span>${bean.name} (NT$${bean.price}) - åº«å­˜: ${bean.stock}</span>
                        <div>
                            <button class="btn-yellow text-sm py-1 px-2 mr-1 edit-coffee-btn">ç·¨è¼¯</button>
                            <button class="btn-red text-sm py-1 px-2 delete-coffee-btn">åˆªé™¤</button>
                        </div>
                    `;
                    adminCoffeeList.appendChild(listItem);
                });

                // Attach event listeners for edit and delete
                document.querySelectorAll('.edit-coffee-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.closest('li').dataset.id;
                        const beanToEdit = coffeeBeans.find(b => b.id === id); // Find by Firestore ID
                        if (beanToEdit) {
                            editCoffeeIdInput.value = beanToEdit.id;
                            coffeeNameInput.value = beanToEdit.name;
                            coffeeCountryInput.value = beanToEdit.country || '';
                            coffeeVarietyInput.value = beanToEdit.variety || '';
                            coffeeFlavorInput.value = beanToEdit.flavor;
                            coffeeRoastInput.value = beanToEdit.roast || '';
                            coffeeWeightInput.value = beanToEdit.weight || '';
                            coffeePriceInput.value = beanToEdit.price;
                            coffeeExpiryInput.value = beanToEdit.expiryDate;
                            coffeeStockInput.value = beanToEdit.stock;
                            coffeeCategoryInput.value = beanToEdit.category || '';
                            coffeeImageInput.value = beanToEdit.image;
                            coffeeLifestyleInput.value = beanToEdit.lifestyle;

                            if (beanToEdit.flavorProfile) {
                                fpAcidityInput.value = beanToEdit.flavorProfile.acidity || 0;
                                fpBodyInput.value = beanToEdit.flavorProfile.body || 0;
                                fpSweetnessInput.value = beanToEdit.flavorProfile.sweetness || 0;
                                fpAromaInput.value = beanToEdit.flavorProfile.aroma || 0;
                                fpFinishInput.value = beanToEdit.flavorProfile.finish || 0;
                            } else {
                                fpAcidityInput.value = ''; fpBodyInput.value = ''; fpSweetnessInput.value = '';
                                fpAromaInput.value = ''; fpFinishInput.value = '';
                            }
                        }
                    });
                });

                document.querySelectorAll('.delete-coffee-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const id = e.target.closest('li').dataset.id;
                        showAdminMessageModal('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤æ­¤å’–å•¡è±†å—ï¼Ÿ', 'info', async () => {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/coffeeBeans`, id));
                                showAdminMessageModal('æˆåŠŸ', 'å’–å•¡è±†å·²åˆªé™¤ï¼', 'success');
                                clearCoffeeForm();
                            } catch (error) {
                                console.error("Error deleting coffee bean:", error);
                                showAdminMessageModal('éŒ¯èª¤', `åˆªé™¤å’–å•¡è±†å¤±æ•—: ${error.message}`, 'error');
                            }
                        }, true); // Pass true for confirmation
                    });
                });
            }

            // Load coffee beans from Firestore with real-time listener
            function loadCoffeeBeans() {
                onSnapshot(query(coffeeBeansCollection), (snapshot) => {
                    const beansFromFirestore = [];
                    snapshot.forEach(doc => {
                        beansFromFirestore.push({ id: doc.id, ...doc.data() });
                    });

                    if (beansFromFirestore.length === 0) {
                        // If Firestore is empty, seed with default data
                        if (coffeeBeans.length === 0) { // Only seed if local array is also empty
                             defaultCoffeeBeans.forEach(async (bean) => {
                                try {
                                    // Use setDoc with a generated ID if you want a specific ID,
                                    // or addDoc for auto-generated ID without specifying.
                                    // For initial seeding, using addDoc is simpler.
                                    await addDoc(coffeeBeansCollection, bean);
                                } catch (error) {
                                    console.error("Error seeding default coffee bean:", error);
                                }
                            });
                            showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'è³‡æ–™åº«ç„¡æ•¸æ“šï¼Œå·²è¼‰å…¥é è¨­å’–å•¡è±†æ•¸æ“šã€‚', 'success');
                        } else {
                            showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'è³‡æ–™åº«ç„¡æ•¸æ“šï¼Œè«‹æ–°å¢æˆ–å„²å­˜å’–å•¡è±†ã€‚', 'info');
                        }
                    } else {
                        coffeeBeans = beansFromFirestore;
                        showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'å’–å•¡è±†æ•¸æ“šå·²å¾è³‡æ–™åº«è¼‰å…¥ã€‚', 'success');
                    }
                    renderCoffeeBeansAdmin();
                    clearCoffeeForm();
                }, (error) => {
                    console.error("Error listening to coffee beans:", error);
                    showAdminMessageModal('éŒ¯èª¤', `è¼‰å…¥å’–å•¡è±†æ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
                });
            }

            // Save coffee beans to Firestore (re-sync or add/update based on edit-coffee-id)
            async function saveCoffeeBeans() {
                showAdminMessageModal('è³‡è¨Š', 'æ­£åœ¨å°‡å’–å•¡è±†æ•¸æ“šåŒæ­¥åˆ°è³‡æ–™åº«...', 'info');
                try {
                    // Fetch current data from the UI to ensure we save what's displayed or edited
                    const currentBeansOnUI = [];
                    document.querySelectorAll('#admin-coffee-list li').forEach(li => {
                        const id = li.dataset.id;
                        const bean = coffeeBeans.find(b => b.id === id); // Get the full bean object
                        if (bean) {
                            currentBeansOnUI.push(bean);
                        }
                    });

                    // Clear existing collection (this is a simple sync, for real apps consider merge/batch writes)
                    // Note: This approach clears and re-adds. For large datasets, this is inefficient.
                    // A better approach would be to track changes (add/update/delete) locally and apply them via batch writes.
                    // For simplicity, we will just rely on the onSnapshot listener for updates after add/update/delete actions.
                    // This button will now serve more as a "Trigger Initial Load/Re-seed" if needed.
                    
                    // For a "Save All" button, a more robust logic would be to compare local `coffeeBeans`
                    // with current Firestore data and perform batched updates/deletes/adds.
                    // However, given the onSnapshot is already active and handling real-time,
                    // this button's primary role might simply be to trigger a re-seed if the collection is empty.
                    
                    // Let's keep this as a simple "Confirm data is loaded/synced" rather than a destructive "save all".
                    // The add/update/delete buttons will handle the actual Firestore writes.
                    
                    // To truly "save all" as implied by the button, we would iterate `coffeeBeans` and `setDoc` each.
                    // For this example, let's just confirm the onSnapshot is working.
                    
                    // If the user truly expects "Save all currently visible items to Firestore",
                    // we would fetch all documents and delete them, then re-add everything in `coffeeBeans`.
                    // This is usually not how real-time databases are used.
                    // Let's change the button's behavior to re-load from Firestore,
                    // and rely on the Add/Update/Delete buttons for actual writes.
                    
                    // Re-calling loadCoffeeBeans will refresh the data from Firestore.
                    loadCoffeeBeans(); 
                    showAdminMessageModal('å·²åŒæ­¥', 'å’–å•¡è±†æ•¸æ“šå·²èˆ‡è³‡æ–™åº«åŒæ­¥ã€‚', 'success'); // Change message
                } catch (error) {
                    console.error("Error saving coffee beans:", error);
                    showAdminMessageModal('éŒ¯èª¤', `å„²å­˜å’–å•¡è±†æ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
                }
            }

            function clearCoffeeForm() {
                editCoffeeIdInput.value = '';
                coffeeNameInput.value = '';
                coffeeCountryInput.value = '';
                coffeeVarietyInput.value = '';
                coffeeFlavorInput.value = '';
                coffeeRoastInput.value = '';
                coffeeWeightInput.value = '';
                coffeePriceInput.value = '';
                coffeeExpiryInput.value = '';
                coffeeStockInput.value = '';
                coffeeCategoryInput.value = '';
                coffeeImageInput.value = '';
                coffeeLifestyleInput.value = '';
                fpAcidityInput.value = '';
                fpBodyInput.value = '';
                fpSweetnessInput.value = '';
                fpAromaInput.value = '';
                fpFinishInput.value = '';
            }

            // --- Special Offer Functions (Firestore) ---
            function renderSpecialOffersAdmin() {
                adminOfferList.innerHTML = '';
                if (specialOffers.length === 0) {
                    adminOfferList.innerHTML = '<li>ç›®å‰æ²’æœ‰å„ªæƒ æ´»å‹•æ•¸æ“šã€‚</li>';
                    return;
                }
                specialOffers.forEach(offer => {
                    const listItem = document.createElement('li');
                    listItem.dataset.id = offer.id; // Use Firestore doc.id
                    listItem.innerHTML = `
                        <span>${offer.name} (NT$${offer.specialPrice})</span>
                        <div>
                            <button class="btn-yellow text-sm py-1 px-2 mr-1 edit-offer-btn">ç·¨è¼¯</button>
                            <button class="btn-red text-sm py-1 px-2 delete-offer-btn">åˆªé™¤</button>
                        </div>
                    `;
                    adminOfferList.appendChild(listItem);
                });

                // Attach event listeners for edit and delete
                document.querySelectorAll('.edit-offer-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.closest('li').dataset.id;
                        const offerToEdit = specialOffers.find(o => o.id === id);
                        if (offerToEdit) {
                            editOfferIdInput.value = offerToEdit.id;
                            offerNameInput.value = offerToEdit.name;
                            offerDescriptionInput.value = offerToEdit.description;
                            offerOriginalPriceInput.value = offerToEdit.originalPrice;
                            offerSpecialPriceInput.value = offerToEdit.specialPrice;
                            offerImageInput.value = offerToEdit.image;
                        }
                    });
                });

                document.querySelectorAll('.delete-offer-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const id = e.target.closest('li').dataset.id;
                        showAdminMessageModal('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤æ­¤å„ªæƒ å—ï¼Ÿ', 'info', async () => {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/specialOffers`, id));
                                showAdminMessageModal('æˆåŠŸ', 'å„ªæƒ æ´»å‹•å·²åˆªé™¤ï¼', 'success');
                                clearOfferForm();
                            } catch (error) {
                                console.error("Error deleting offer:", error);
                                showAdminMessageModal('éŒ¯èª¤', `åˆªé™¤å„ªæƒ å¤±æ•—: ${error.message}`, 'error');
                            }
                        }, true); // Pass true for confirmation
                    });
                });
            }

            // Load special offers from Firestore with real-time listener
            function loadSpecialOffers() {
                onSnapshot(query(specialOffersCollection), (snapshot) => {
                    const offersFromFirestore = [];
                    snapshot.forEach(doc => {
                        offersFromFirestore.push({ id: doc.id, ...doc.data() });
                    });

                    if (offersFromFirestore.length === 0) {
                        // If Firestore is empty, seed with default data
                        if (specialOffers.length === 0) { // Only seed if local array is also empty
                            window.OfferDataManager.DEFAULT_SPECIAL_OFFERS.forEach(async (offer) => {
                                try {
                                    // Use setDoc with the default ID
                                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/specialOffers`, offer.id), offer);
                                } catch (error) {
                                    console.error("Error seeding default special offer:", error);
                                }
                            });
                            showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'è³‡æ–™åº«ç„¡æ•¸æ“šï¼Œå·²è¼‰å…¥é è¨­å„ªæƒ æ´»å‹•ã€‚', 'success');
                        } else {
                            showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'è³‡æ–™åº«ç„¡æ•¸æ“šï¼Œè«‹æ–°å¢æˆ–å„²å­˜å„ªæƒ æ´»å‹•ã€‚', 'info');
                        }
                    } else {
                        specialOffers = offersFromFirestore;
                        showAdminMessageModal('è¼‰å…¥æˆåŠŸ', 'å„ªæƒ æ•¸æ“šå·²å¾è³‡æ–™åº«è¼‰å…¥ã€‚', 'success');
                    }
                    renderSpecialOffersAdmin();
                    clearOfferForm();
                }, (error) => {
                    console.error("Error listening to special offers:", error);
                    showAdminMessageModal('éŒ¯èª¤', `è¼‰å…¥å„ªæƒ æ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
                });
            }

            // Save special offers to Firestore (re-sync or add/update based on edit-offer-id)
            async function saveSpecialOffers() {
                showAdminMessageModal('è³‡è¨Š', 'æ­£åœ¨å°‡å„ªæƒ æ•¸æ“šåŒæ­¥åˆ°è³‡æ–™åº«...', 'info');
                try {
                    loadSpecialOffers(); // Re-calling load will refresh from Firestore
                    showAdminMessageModal('å·²åŒæ­¥', 'å„ªæƒ æ•¸æ“šå·²èˆ‡è³‡æ–™åº«åŒæ­¥ã€‚', 'success'); // Change message
                } catch (error) {
                    console.error("Error saving special offers:", error);
                    showAdminMessageModal('éŒ¯èª¤', `å„²å­˜å„ªæƒ æ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
                }
            }

            function clearOfferForm() {
                editOfferIdInput.value = '';
                offerNameInput.value = '';
                offerDescriptionInput.value = '';
                offerOriginalPriceInput.value = '';
                offerSpecialPriceInput.value = '';
                offerImageInput.value = '';
            }

            // --- Event Listeners ---
            document.addEventListener('DOMContentLoaded', () => {
                // Coffee Bean Event Listeners
                loadCoffeeBtn.addEventListener('click', loadCoffeeBeans);
                saveCoffeeBtn.addEventListener('click', saveCoffeeBeans); // Now acts as a re-load/sync trigger

                addCoffeeBtn.addEventListener('click', async () => {
                    if (!coffeeNameInput.value || !coffeePriceInput.value || coffeeStockInput.value === '') {
                        showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å’–å•¡è±†æ¬„ä½ã€‚', 'error');
                        return;
                    }

                    const newBeanData = {
                        name: coffeeNameInput.value,
                        country: coffeeCountryInput.value,
                        variety: coffeeVarietyInput.value,
                        flavor: coffeeFlavorInput.value,
                        roast: coffeeRoastInput.value,
                        weight: coffeeWeightInput.value,
                        price: parseFloat(coffeePriceInput.value) || 0,
                        expiryDate: coffeeExpiryInput.value,
                        stock: parseInt(coffeeStockInput.value) || 0,
                        category: coffeeCategoryInput.value,
                        image: coffeeImageInput.value || 'https://placehold.co/400x200/cccccc/333333?text=æ–°å’–å•¡è±†',
                        flavorProfile: { 
                            acidity: parseFloat(fpAcidityInput.value) || 0, 
                            body: parseFloat(fpBodyInput.value) || 0, 
                            sweetness: parseFloat(fpSweetnessInput.value) || 0, 
                            aroma: parseFloat(fpAromaInput.value) || 0, 
                            finish: parseFloat(fpFinishInput.value) || 0 
                        }, 
                        lifestyle: coffeeLifestyleInput.value || 'äº«å—ä¸€æ¯ç¾å¥½çš„å’–å•¡ã€‚'
                    };

                    try {
                        await addDoc(coffeeBeansCollection, newBeanData);
                        showAdminMessageModal('æˆåŠŸ', 'å’–å•¡è±†å·²æ–°å¢ï¼', 'success');
                        clearCoffeeForm();
                    } catch (error) {
                        console.error("Error adding coffee bean:", error);
                        showAdminMessageModal('éŒ¯èª¤', `æ–°å¢å’–å•¡è±†å¤±æ•—: ${error.message}`, 'error');
                    }
                });

                updateCoffeeBtn.addEventListener('click', async () => {
                    const idToUpdate = editCoffeeIdInput.value;
                    if (!idToUpdate) {
                        showAdminMessageModal('æ›´æ–°éŒ¯èª¤', 'è«‹é¸æ“‡è¦æ›´æ–°çš„å’–å•¡è±†ã€‚', 'error');
                        return;
                    }

                    if (!coffeeNameInput.value || !coffeePriceInput.value || coffeeStockInput.value === '') {
                        showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å’–å•¡è±†æ¬„ä½ã€‚', 'error');
                        return;
                    }

                    const updatedBeanData = {
                        name: coffeeNameInput.value,
                        country: coffeeCountryInput.value,
                        variety: coffeeVarietyInput.value,
                        flavor: coffeeFlavorInput.value,
                        roast: coffeeRoastInput.value,
                        weight: coffeeWeightInput.value,
                        price: parseFloat(coffeePriceInput.value) || 0,
                        expiryDate: coffeeExpiryInput.value,
                        stock: parseInt(coffeeStockInput.value) || 0,
                        category: coffeeCategoryInput.value,
                        image: coffeeImageInput.value || 'https://placehold.co/400x200/cccccc/333333?text=æ›´æ–°å’–å•¡è±†', // Provide a fallback if image is cleared
                        lifestyle: coffeeLifestyleInput.value,
                        flavorProfile: {
                            acidity: parseFloat(fpAcidityInput.value) || 0,
                            body: parseFloat(fpBodyInput.value) || 0,
                            sweetness: parseFloat(fpSweetnessInput.value) || 0,
                            aroma: parseFloat(fpAromaInput.value) || 0,
                            finish: parseFloat(fpFinishInput.value) || 0
                        }
                    };

                    try {
                        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/coffeeBeans`, idToUpdate), updatedBeanData);
                        showAdminMessageModal('æˆåŠŸ', 'å’–å•¡è±†å·²æ›´æ–°ï¼', 'success');
                        clearCoffeeForm();
                    } catch (error) {
                        console.error("Error updating coffee bean:", error);
                        showAdminMessageModal('éŒ¯èª¤', `æ›´æ–°å’–å•¡è±†å¤±æ•—: ${error.message}`, 'error');
                    }
                });

                clearCoffeeFormBtn.addEventListener('click', clearCoffeeForm);

                // Special Offer Event Listeners
                loadOfferBtn.addEventListener('click', loadSpecialOffers);
                saveOfferBtn.addEventListener('click', saveSpecialOffers); // Now acts as a re-load/sync trigger

                addOfferBtn.addEventListener('click', async () => {
                    if (!offerNameInput.value || !offerDescriptionInput.value || !offerOriginalPriceInput.value || !offerSpecialPriceInput.value) {
                        showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å„ªæƒ æ´»å‹•æ¬„ä½ã€‚', 'error');
                        return;
                    }

                    const newOfferData = { 
                        name: offerNameInput.value,
                        description: offerDescriptionInput.value,
                        originalPrice: parseFloat(offerOriginalPriceInput.value) || 0,
                        specialPrice: parseFloat(offerSpecialPriceInput.value) || 0,
                        image: offerImageInput.value || 'https://placehold.co/400x250/cccccc/333333?text=æ–°å„ªæƒ '
                    };

                    try {
                        await addDoc(specialOffersCollection, newOfferData);
                        showAdminMessageModal('æˆåŠŸ', 'å„ªæƒ æ´»å‹•å·²æ–°å¢ï¼', 'success');
                        clearOfferForm();
                    } catch (error) {
                        console.error("Error adding offer:", error);
                        showAdminMessageModal('éŒ¯èª¤', `æ–°å¢å„ªæƒ å¤±æ•—: ${error.message}`, 'error');
                    }
                });

                updateOfferBtn.addEventListener('click', async () => {
                    const idToUpdate = editOfferIdInput.value;
                    if (!idToUpdate) {
                        showAdminMessageModal('æ›´æ–°éŒ¯èª¤', 'è«‹é¸æ“‡è¦æ›´æ–°çš„å„ªæƒ æ´»å‹•ã€‚', 'error');
                        return;
                    }

                    if (!offerNameInput.value || !offerDescriptionInput.value || !offerOriginalPriceInput.value || !offerSpecialPriceInput.value) {
                        showAdminMessageModal('è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨»ç‚ºã€Œå¿…å¡«ã€çš„å„ªæƒ æ´»å‹•æ¬„ä½ã€‚', 'error');
                        return;
                    }

                    const updatedOfferData = {
                        name: offerNameInput.value,
                        description: offerDescriptionInput.value,
                        originalPrice: parseFloat(offerOriginalPriceInput.value) || 0,
                        specialPrice: parseFloat(offerSpecialPriceInput.value) || 0,
                        image: offerImageInput.value || 'https://placehold.co/400x250/cccccc/333333?text=æ›´æ–°å„ªæƒ ' // Provide a fallback if image is cleared
                    };
                    
                    try {
                        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/specialOffers`, idToUpdate), updatedOfferData);
                        showAdminMessageModal('æˆåŠŸ', 'å„ªæƒ æ´»å‹•å·²æ›´æ–°ï¼', 'success');
                        clearOfferForm();
                    } catch (error) {
                        console.error("Error updating offer:", error);
                        showAdminMessageModal('éŒ¯èª¤', `æ›´æ–°å„ªæƒ å¤±æ•—: ${error.message}`, 'error');
                    }
                });

                clearOfferFormBtn.addEventListener('click', clearOfferForm);

                // Initial load for admin panel when opened
                // Use onAuthStateChanged to ensure Firebase is ready before loading data
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Ensure userId is correctly set after auth
                        loadCoffeeBeans(); 
                        loadSpecialOffers();
                    } else {
                        // User is signed out or not authenticated (e.g., anonymous failure)
                        showAdminMessageModal('éŒ¯èª¤', 'æœªèªè­‰ä½¿ç”¨è€…ã€‚æŸäº›åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚', 'error');
                    }
                });
            });

        })(); // End IIFE
    </script>
</body>
</html>
